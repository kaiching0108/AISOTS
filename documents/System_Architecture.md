# AI æœŸè²¨äº¤æ˜“ç³»çµ± - ç³»çµ±æ¶æ§‹èªªæ˜

## 1. ç³»çµ±æ¦‚è¿°

### 1.1 ç³»çµ±ç›®æ¨™

æœ¬ç³»çµ±æ˜¯ä¸€å€‹åŸºæ–¼ AI Agent çš„æœŸè²¨è‡ªå‹•äº¤æ˜“ç³»çµ±ï¼Œé€éæ°¸è±æœŸè²¨ Shioaji API é€²è¡Œäº¤æ˜“ï¼Œä¸¦æ•´åˆ LLM å¤§èªè¨€æ¨¡å‹å¯¦ç¾è‡ªç„¶èªè¨€äº¤æ˜“æ“ä½œèˆ‡ç­–ç•¥ç”Ÿæˆã€‚

### 1.2 æŠ€è¡“å †ç–Š

| å±¤é¢ | æŠ€è¡“ |
|------|------|
| äº¤æ˜“ API | Shioaji (æ°¸è±æœŸè²¨) |
| ç¨‹å¼èªè¨€ | Python 3.10+ |
| AI Agent | Nanobot æ¶æ§‹æ¦‚å¿µ |
| LLM | OpenRouter / OpenAI / Anthropic / Ollama (æœ¬åœ°) |
| æŠ€è¡“æŒ‡æ¨™ | pandas_ta |
| é€šçŸ¥ | Telegram Bot |
| è³‡æ–™å„²å­˜ | JSON æª”æ¡ˆ |

---

## 2. ç³»çµ±æ¶æ§‹åœ–

### 2.1 æ•´é«”æ¶æ§‹ (8å±¤)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Layer (ç”¨æˆ¶å±¤)                          â”‚
â”‚     Web Interface (ä¸»è¦) / Telegram Notification (é€šçŸ¥)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Agent Layer (AI Agent å±¤)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Trading Tools  â”‚  â”‚ System Prompt   â”‚  â”‚  LLM Provider   â”‚    â”‚
â”‚  â”‚  - place_order  â”‚  â”‚                 â”‚  â”‚                 â”‚    â”‚
â”‚  â”‚  - get_positionâ”‚  â”‚  äº¤æ˜“è¦å‰‡       â”‚  â”‚  GPT/Claude     â”‚    â”‚
â”‚  â”‚  - get_perform â”‚  â”‚ ç­–ç•¥å®šç¾©       â”‚  â”‚  Ollama         â”‚    â”‚
â”‚  â”‚  - è‡ªå‹•ç”ŸæˆID  â”‚  â”‚ å°è©±æ­·å²       â”‚  â”‚                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Engine Layer (å¼•æ“å±¤) - ç­–ç•¥åŸ·è¡Œ                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ LLM Generator   â”‚  â”‚ TradingStrategy â”‚  â”‚ StrategyExecutorâ”‚    â”‚
â”‚  â”‚  ç­–ç•¥ä»£ç¢¼ç”Ÿæˆ   â”‚  â”‚    ç­–ç•¥æ¡†æ¶     â”‚  â”‚   ç­–ç•¥åŸ·è¡Œå™¨     â”‚    â”‚
â”‚  â”‚  (è‡ªç”±æ ¼å¼)     â”‚  â”‚ (TradingStrategy)â”‚ â”‚                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Business Layer (æ¥­å‹™å±¤)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Strategy Managerâ”‚  â”‚ Position Managerâ”‚  â”‚  Order Manager  â”‚      â”‚
â”‚  â”‚   ç®¡ç†å¤šç­–ç•¥     â”‚  â”‚  æŒ‰ç­–ç•¥åˆ†é–‹éƒ¨ä½  â”‚  â”‚    è¨‚å–®ç®¡ç†     â”‚      â”‚
â”‚  â”‚  (è‡ªå‹•ç”ŸæˆID)   â”‚  â”‚                 â”‚  â”‚                 â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Agent Layer (AI Agent å±¤)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Trading Tools  â”‚  â”‚ System Prompt   â”‚  â”‚  LLM Provider   â”‚    â”‚
â”‚  â”‚  - place_order  â”‚  â”‚                 â”‚  â”‚                 â”‚    â”‚
â”‚  â”‚  - get_positionâ”‚  â”‚  äº¤æ˜“è¦å‰‡       â”‚  â”‚  GPT/Claude     â”‚    â”‚
â”‚  â”‚  - get_perform â”‚  â”‚  ç­–ç•¥å®šç¾©       â”‚  â”‚  Ollama         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Engine Layer (å¼•æ“å±¤) - ç­–ç•¥åŸ·è¡Œ                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ LLM Generator   â”‚  â”‚ TradingStrategy â”‚  â”‚ StrategyExecutorâ”‚    â”‚
â”‚  â”‚  ç­–ç•¥ä»£ç¢¼ç”Ÿæˆ   â”‚  â”‚    ç­–ç•¥æ¡†æ¶     â”‚  â”‚   ç­–ç•¥åŸ·è¡Œå™¨     â”‚    â”‚
â”‚  â”‚  (è‡ªç”±æ ¼å¼)     â”‚  â”‚ (TradingStrategy)â”‚ â”‚                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Business Layer (æ¥­å‹™å±¤)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Strategy Managerâ”‚  â”‚ Position Managerâ”‚  â”‚  Order Manager  â”‚      â”‚
â”‚  â”‚   ç®¡ç†3å€‹ç­–ç•¥    â”‚  â”‚  æŒ‰ç­–ç•¥åˆ†é–‹éƒ¨ä½  â”‚  â”‚    è¨‚å–®ç®¡ç†     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Risk Layer (é¢¨æ§å±¤)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Risk Manager                             â”‚    â”‚
â”‚  â”‚  - å–®æ—¥æœ€å¤§è™§ææª¢æŸ¥  - æœ€å¤§éƒ¨ä½æª¢æŸ¥   - é »ç‡é™åˆ¶           â”‚    â”‚
â”‚  â”‚  - åœææ­¢ç›ˆç›£æ§     - ç•°å¸¸è¨‚å–®æª¢æŸ¥                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Adapter Layer (é©é…å±¤)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Shioaji Client  â”‚  â”‚ Connection Mgr   â”‚  â”‚ Order Callback  â”‚    â”‚
â”‚  â”‚                 â”‚  â”‚  æ–·ç·šé‡é€£æ©Ÿåˆ¶    â”‚  â”‚                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Layer (Shioaji API)                         â”‚
â”‚                    æ°¸è±æœŸè²¨ API                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Market Data (å¸‚å ´)                                â”‚
â”‚                    æœŸè²¨äº¤æ˜“æ‰€                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Fallback å‘½ä»¤è™•ç†æ©Ÿåˆ¶

ç³»çµ±åœ¨ Agent Layer å’Œ LLM ä¹‹é–“å¯¦ç¾äº† **Fallback æ©Ÿåˆ¶**ï¼š

```
User Command
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Regex Pattern Match   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    æ˜¯          å¦
     â”‚           â”‚
     â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›´æ¥    â”‚  â”‚  LLM è™•ç†      â”‚
â”‚ å‡½å¼    â”‚  â”‚  (è‡ªç„¶èªè¨€)    â”‚
â”‚ èª¿ç”¨    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¯æ´çš„å‘½ä»¤**ï¼š`create`, `status`, `positions`, `strategies`, `performance`, `risk`, `orders`, `enable <ID>`, `disable <ID>`, `new`, `help`

**ç›´æ¥è™•ç†çš„è¼¸å…¥**ï¼š
- æ‰€æœ‰æ˜ç¢ºè‹±æ–‡æŒ‡ä»¤ â†’ Fallback ç›´æ¥åŸ·è¡Œï¼Œç¢ºä¿ 100% æˆåŠŸ
- `create` â†’ å•ç­”å¼å»ºç«‹ç­–ç•¥æµç¨‹
- `enable <ID>` / `disable <ID>` â†’ ç›´æ¥åŸ·è¡Œ
- `status`, `positions`, `strategies` ç­‰ â†’ ç›´æ¥æŸ¥è©¢

**LLM è™•ç†ç¯„åœ**ï¼š
- ç›®æ¨™é©…å‹•å»ºç«‹ç­–ç•¥
- ç­–ç•¥è¨è«–

**å„ªå‹¢**ï¼šç¢ºä¿åŸºæœ¬å‘½ä»¤ 100% åŸ·è¡ŒæˆåŠŸï¼ŒéŸ¿æ‡‰é€Ÿåº¦æ›´å¿«ï¼Œä¸ä¾è³´ LLM å·¥å…·èª¿ç”¨ç©©å®šæ€§

### 2.3 Telegram Markdown æ¸…ç†æ©Ÿåˆ¶

ç³»çµ±åœ¨ç™¼é€è¨Šæ¯åˆ° Telegram å‰ï¼Œè‡ªå‹•æ¸…ç† Markdown æ ¼å¼ï¼š

| é …ç›® | è™•ç†æ–¹å¼ |
|------|----------|
| ç²—é«” **text** | ç§»é™¤ ** æ¨™è¨˜ |
| æ–œé«” *text* | ç§»é™¤ * æ¨™è¨˜ |
| æ¨™é¡Œ ### | ç§»é™¤ # æ¨™è¨˜ |
| è¡¨æ ¼ | è½‰æ›ç‚ºæ¸…å–®æ ¼å¼ |
| åˆ†éš”ç·š --- | æ”¹ç‚º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ |

### 2.4 ç­–ç•¥åŸ·è¡Œæµç¨‹

```
ç”¨æˆ¶ç­–ç•¥æè¿°
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM Generator   â”‚ â—„â”€â”€â”€ å°‡æè¿°è½‰æ›ç‚ºç­–ç•¥ç¨‹å¼ç¢¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Strategy Class  â”‚ â—„â”€â”€â”€ ç¹¼æ‰¿ TradingStrategy
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StrategyExecutorâ”‚ â—„â”€â”€â”€ åŸ·è¡Œç­–ç•¥çš„ on_bar()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚ buy   â”‚ â”‚ sell  â”‚
â”‚ close â”‚ â”‚ hold  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ•¸æ“šæµå‘åœ–

```
ç”¨æˆ¶æŒ‡ä»¤ (Web Interface)
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ¤æ–·æŒ‡ä»¤é¡å‹    â”‚ â—„â”€â”€â”€ åˆ†ææ˜¯æ˜ç¢ºæŒ‡ä»¤é‚„æ˜¯ç›®æ¨™é©…å‹•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜ç¢ºæŒ‡ä»¤ â”‚ â”‚ LLM    â”‚
â”‚ (Fallback)â”‚         â”‚ â—„â”€â”€â”€ ç›®æ¨™é©…å‹•ã€ç­–ç•¥è¨è«–
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚           â”‚
     â–¼           â–¼
ç›´æ¥åŸ·è¡Œ   ç­–ç•¥ç›¸é—œè™•ç†

---

## 3. æ ¸å¿ƒæ¨¡çµ„èªªæ˜

### 3.1 API å±¤ (src/api/)

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `shioaji_client.py` | Shioaji API å°è£ï¼ŒåŒ…å«ç™»å…¥ã€ä¸‹å–®ã€å–å¾—éƒ¨ä½ç­‰ |
| `connection.py` | é€£ç·šç®¡ç†ï¼Œè‡ªå‹•é‡é€£æ©Ÿåˆ¶ |
| `order_callback.py` | è¨‚å–®/å ±åƒ¹å›èª¿è™•ç† |

### 3.2 äº¤æ˜“å±¤ (src/trading/)

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `strategy.py` | ç­–ç•¥é¡åˆ¥ (å« LLM ç”Ÿæˆç¨‹å¼ç¢¼æ¬„ä½) |
| `strategy_manager.py` | ç­–ç•¥ç®¡ç†å™¨ï¼Œç®¡ç†3å€‹ç­–ç•¥ |
| `position.py` | éƒ¨ä½é¡åˆ¥ |
| `position_manager.py` | éƒ¨ä½ç®¡ç†å™¨ï¼ŒæŒ‰ç­–ç•¥åˆ†é–‹è¿½è¹¤ |
| `order.py` | è¨‚å–®é¡åˆ¥ |
| `order_manager.py` | è¨‚å–®ç®¡ç†å™¨ |

### 3.3 å¼•æ“å±¤ (src/engine/)

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `framework.py` | ç­–ç•¥æ¡†æ¶ (TradingStrategy, StrategyExecutor) |
| `llm_generator.py` | LLM ç­–ç•¥ç”Ÿæˆå™¨ |
| `runner.py` | ç­–ç•¥åŸ·è¡Œå”èª¿å™¨ |
| `backtest_engine.py` | backtesting.py æ­·å²å›æ¸¬å¼•æ“ |

### 3.4 å¸‚å ´æ•¸æ“šå±¤ (src/market/)

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `price_cache.py` | åƒ¹æ ¼å¿«å– |
| `data_service.py` | å¸‚å ´è³‡æ–™æœå‹™ |

### 3.5 é¢¨æ§å±¤ (src/risk/)

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `risk_manager.py` | é¢¨æ§æª¢æŸ¥ã€åœææ­¢ç›ˆç›£æ§ |

### 3.6 é€šçŸ¥å±¤ (src/notify/)

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `telegram.py` | Telegram æ©Ÿå™¨äººé€šçŸ¥ |

### 3.7 Agent å±¤ (src/agent/)

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `tools.py` | AI Agent äº¤æ˜“å·¥å…·é›† (å«ç­–ç•¥ç®¡ç†å·¥å…·) |
| `prompts.py` | ç³»çµ±æç¤ºè© |
| `providers.py` | LLM æä¾›è€… (Ollama/OpenAI/Anthropic/OpenRouter) |

#### Agent Tools ä¸€è¦½

| Tool åç¨± | åŠŸèƒ½ |
|-----------|------|
| `create_strategy` | å»ºç«‹æ–°ç­–ç•¥ |
| `update_strategy_prompt` | æ›´æ–°ç­–ç•¥æè¿° |
| `delete_strategy` | åˆªé™¤ç­–ç•¥ |
| `enable_strategy` | å•Ÿç”¨ç­–ç•¥ |
| `disable_strategy` | åœç”¨ç­–ç•¥ |
| `place_order` | æ‰‹å‹•ä¸‹å–® |
| `close_position` | å¹³å€‰ |
| `get_positions` | å–å¾—éƒ¨ä½ |
| `get_strategies` | å–å¾—ç­–ç•¥åˆ—è¡¨ |
| `get_performance` | å–å¾—ç¸¾æ•ˆ |

---

## 4. ç­–ç•¥æ¡†æ¶èªªæ˜

### 4.1 TradingStrategy æŠ½è±¡é¡åˆ¥

æ‰€æœ‰ LLM ç”Ÿæˆçš„ç­–ç•¥å¿…é ˆç¹¼æ‰¿ `TradingStrategy`ï¼š

```python
from src.engine.framework import TradingStrategy, BarData

class MyStrategy(TradingStrategy):
    def __init__(self, symbol: str):
        super().__init__(symbol)
    
    def on_bar(self, bar: BarData) -> str:
        # ç­–ç•¥é‚è¼¯
        return 'hold'  # æˆ– 'buy', 'sell', 'close'
```

### 4.2 BarDataï¼ˆKæ£’è³‡æ–™ï¼‰

| å±¬æ€§ | èªªæ˜ |
|------|------|
| `bar.timestamp` | æ™‚é–“æˆ³ |
| `bar.open` | é–‹ç›¤åƒ¹ |
| `bar.high` | æœ€é«˜åƒ¹ |
| `bar.low` | æœ€ä½åƒ¹ |
| `bar.close` | æ”¶ç›¤åƒ¹ |
| `bar.volume` | æˆäº¤é‡ |
| `bar.pct_change` | æ¼²è·Œå¹…ï¼ˆå°æ•¸ï¼Œå¦‚ 0.05 ä»£è¡¨ 5%ï¼‰ |
| `bar.get_change_from(price)` | ç›¸å°æ–¼æŸåƒ¹æ ¼çš„æ¼²è·Œå¹… |

### 4.3 FillDataï¼ˆæˆäº¤å›å ±ï¼‰

| å±¬æ€§ | èªªæ˜ |
|------|------|
| `fill.symbol` | åˆç´„ä»£ç¢¼ |
| `fill.side` | è²·è³£æ–¹å‘ ('buy' æˆ– 'sell') |
| `fill.price` | æˆäº¤åƒ¹æ ¼ |
| `fill.quantity` | æˆäº¤æ•¸é‡ |
| `fill.timestamp` | æˆäº¤æ™‚é–“ |

### 4.4 å¯ç”¨å±¬æ€§

| å±¬æ€§ | èªªæ˜ |
|------|------|
| `self.position` | ç•¶å‰éƒ¨ä½ (æ­£=å¤šå–®ï¼Œè² =ç©ºå–®ï¼Œ0=ç„¡éƒ¨ä½) |
| `self.entry_price` | é€²å ´åƒ¹æ ¼ |
| `self.context` | å­—å…¸ï¼Œå¯å„²å­˜è‡ªå®šç¾©ç‹€æ…‹ |
| `self.symbol` | åˆç´„ä»£ç¢¼ |

### 4.5 å¯ç”¨æ–¹æ³•

| æ–¹æ³• | èªªæ˜ |
|------|------|
| `self.get_bars(n)` | å–å¾—æœ€è¿‘ n æ ¹ K æ£’ |
| `self.get_dataframe(n)` | å–å¾— pandas DataFrame |
| `self.ta(æŒ‡æ¨™, **åƒæ•¸)` | ä½¿ç”¨ pandas_ta è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ |
| `self.on_fill(fill)` | æˆäº¤å›èª¿ï¼ˆå¯é¸å¯¦ä½œï¼‰ |

> **æ³¨æ„**ï¼šç•¶ K æ£’æ•¸æ“šä¸è¶³ï¼ˆå°‘æ–¼ 2 æ ¹ï¼‰æ™‚ï¼Œ`ta()` å›å‚³ `None`ã€‚ç­–ç•¥æ‡‰æª¢æŸ¥è¿”å›å€¼æ˜¯å¦ç‚º `None` å†ä½¿ç”¨ã€‚
> 
> ```python
> rsi = self.ta('RSI', period=14)
> if rsi is None:
>     return 'hold'  # æ•¸æ“šä¸è¶³æ™‚ä¿æŒè§€æœ›
> rsi_value = rsi.iloc[-1]
> ```

### 4.6 pandas_ta æ”¯æ´çš„æŒ‡æ¨™

| æŒ‡æ¨™ | èªªæ˜ | åƒæ•¸ |
|------|------|------|
| RSI | ç›¸å°å¼·å¼±æŒ‡æ¨™ | period=14 |
| MACD | æŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·š | fast=12, slow=26, signal=9 |
| SMA | ç°¡å–®ç§»å‹•å¹³å‡ | period=20 |
| EMA | æŒ‡æ•¸ç§»å‹•å¹³å‡ | period=20 |
| BB | å¸ƒæ—å¸¶ | period=20, std=2.0 |
| ATR | å¹³å‡çœŸå¯¦æ³¢å¹… | period=14 |
| STOCH | KD æŒ‡æ¨™ | period=14 |
| ADX | å¹³å‡è¶¨å‘æŒ‡æ¨™ | period=14 |
| CCI | å•†å“é€šé“æŒ‡æ¨™ | period=20 |
| OBV | èƒ½é‡æ½® | - |
| VWAP | æˆäº¤é‡åŠ æ¬Šå¹³å‡åƒ¹ | - |
| WILLR | å¨å»‰æŒ‡æ¨™ | period=14 |

### 4.7 on_bar å›å‚³å€¼

| å›å‚³å€¼ | å‹•ä½œ |
|--------|------|
| `'buy'` | è²·é€²é–‹å¤š |
| `'sell'` | è³£å‡ºé–‹ç©º |
| `'close'` | å¹³å€‰ |
| `'hold'` | ç„¡å‹•ä½œ |

### 4.8 ç­–ç•¥ç¨‹å¼ç¢¼ç¯„ä¾‹

```python
from src.engine.framework import TradingStrategy, BarData

class RSIStrategy(TradingStrategy):
    def __init__(self, symbol: str):
        super().__init__(symbol)
    
    def on_bar(self, bar: BarData) -> str:
        rsi = self.ta('RSI', period=14)
        if rsi is None:
            return 'hold'
        
        rsi_value = rsi.iloc[-1]
        
        if rsi_value < 30 and self.position == 0:
            return 'buy'
        elif rsi_value > 70 and self.position > 0:
            return 'sell'
        elif self.position > 0:
            # æœ‰éƒ¨ä½æ™‚æª¢æŸ¥æ˜¯å¦è©²åœæ/æ­¢ç›ˆ
            pnl_pct = (bar.close - self.entry_price) / self.entry_price
            if pnl_pct < -0.02:  # åœæ 2%
                return 'close'
        
        return 'hold'
```

### 4.9 ç­–ç•¥åŸ·è¡Œæµç¨‹

LLM ç”Ÿæˆç­–ç•¥ç¨‹å¼ç¢¼å¾Œï¼Œç›¯ç›¤åŸ·è¡Œç”±ä»¥ä¸‹å…ƒä»¶è² è²¬ï¼š

| å…ƒä»¶ | æª”æ¡ˆ | è·è²¬ |
|------|------|------|
| `StrategyRunner` | `runner.py` | ç­–ç•¥åŸ·è¡Œå”èª¿å™¨ |
| `StrategyExecutor` | `framework.py` | å¯¦éš›åŸ·è¡Œç­–ç•¥è¨Šè™Ÿ |

#### åŸ·è¡Œæµç¨‹

```
LLM ç”Ÿæˆç­–ç•¥ç¨‹å¼ç¢¼
       â†“
StrategyRunner.start_strategy()  â† å•Ÿå‹•ç­–ç•¥
       â†“
StrategyRunner._create_executor()  â† å»ºç«‹ StrategyExecutor
       â†“
StrategyRunner.run_all_strategies()  â† æ¯ 60 ç§’åŸ·è¡Œ
       â†“
StrategyRunner.execute_strategy()
       â†“
StrategyRunner.execute_strategy_llm()
       â†“
StrategyExecutor.execute_bar(bar)  â† å°‡ K æ£’å‚³å…¥ç­–ç•¥
       â†“
TradingStrategy.on_bar(bar)  â† ç­–ç•¥é‚è¼¯ç”¢ç”Ÿè¨Šè™Ÿ
       â†“
å›å‚³ 'buy'/'sell'/'close'/'hold'
```

#### é—œéµç¨‹å¼ç¢¼ä½ç½®

| åŠŸèƒ½ | è¡Œè™Ÿ |
|------|------|
| åŸ·è¡Œæ‰€æœ‰ç­–ç•¥å¾ªç’° | `runner.py:428` (`run_all_strategies`) |
| å»ºç«‹åŸ·è¡Œå™¨ | `runner.py:285` (`_create_executor`) |
| åŸ·è¡Œç­–ç•¥è¨Šè™Ÿ | `runner.py:313` (`execute_strategy_llm`) |
| åŸ·è¡Œ K æ£’ | `framework.py:216` (`execute_bar`) |

#### åŸ·è¡Œé€±æœŸ

- `run_all_strategies()` æ¯ **60 ç§’**ï¼ˆå¯é…ç½®ï¼‰åŸ·è¡Œä¸€æ¬¡
- æª¢æŸ¥æ‰€æœ‰ `enabled` ä¸” `is_running` çš„ç­–ç•¥
- å°‡æœ€æ–° K æ£’å‚³å…¥ `StrategyExecutor.execute_bar()`
- ç­–ç•¥ç”¢ç”Ÿè¨Šè™Ÿå¾Œï¼Œé€é `on_signal` callback è™•ç†ä¸‹å–®

### 4.10 K Bar è³‡æ–™å–å¾—

#### è³‡æ–™ä¾†æº

| ä¾†æº | æª”æ¡ˆ/æ–¹æ³• | èªªæ˜ |
|------|----------|------|
| æ­·å² K ç·š | `shioaji_client.py:get_kbars()` | å‘¼å« Shioaji API å–å¾—æ­·å² K æ£’ |
| å¯¦æ™‚å ±åƒ¹ | `shioaji_client.py:subscribe_quote()` | è¨‚é–±åˆç´„å³æ™‚å ±åƒ¹ |

#### å–å¾—æµç¨‹

```
1. ç­–ç•¥å•Ÿå‹•æ™‚
   â”‚
   â–¼
Runner.ensure_sufficient_data()
   â”‚
   â–¼
MarketDataService.fetch_historical(symbol, timeframe, count)
   â”‚
   â–¼
ShioajiClient.get_kbars(contract, timeframe, count)
   â”‚
   â–¼
api.kbars(contract)  â† Shioaji API å–å¾—çœŸå¯¦ K ç·š
   â”‚
   â–¼
å›å‚³ K æ£’åˆ—è¡¨ [{timestamp, open, high, low, close, volume}, ...]
```

#### é—œéµç¨‹å¼ç¢¼ä½ç½®

| åŠŸèƒ½ | ä½ç½® |
|------|------|
| å–å¾— K ç·š | `shioaji_client.py:152` (`get_kbars`) |
| Shioaji API å‘¼å« | `shioaji_client.py:158` |
| æ­·å²è³‡æ–™å–å¾— | `data_service.py:131` (`fetch_historical`) |
| å ±åƒ¹è¨‚é–± | `data_service.py:22` (`subscribe`) |
| åƒ¹æ ¼å¿«å– | `price_cache.py:44` (`PriceCache`) |

#### æ¨¡æ“¬ vs éæ¨¡æ“¬

| æ¨¡å¼ | è³‡æ–™ä¾†æº |
|------|----------|
| æ¨¡æ“¬ (`simulation: true`) | `_generate_mock_kbars()` ç”¢ç”Ÿæ¨¡æ“¬è³‡æ–™ |
| éæ¨¡æ“¬ | `api.kbars(contract)` å–å¾—çœŸå¯¦å¸‚å ´è³‡æ–™ |

---
#### å¯¦æ™‚å ±åƒ¹è™•ç†
1. é€é subscribe_quote() è¨‚é–±åˆç´„å ±åƒ¹
2. å ±åƒ¹è³‡æ–™å­˜å…¥ PriceCache
3. StrategyRunner å®šæ™‚å–å¾—æœ€æ–°å ±åƒ¹è½‰æ›ç‚º K æ£’
4. å‚³å…¥ StrategyExecutor.execute_bar() åŸ·è¡Œç­–ç•¥

#### Timeframe è™•ç†

- ç­–ç•¥å•Ÿå‹•æ™‚å¾ `strategy.params.timeframe` è®€å–é€±æœŸåƒæ•¸
- `get_kbars(contract, timeframe, count)` å–å¾—è©²é€±æœŸ K æ£’
- ç”±æ–¼è¨­è¨ˆä¸Šæ¯å€‹ symbol åŒæ™‚åªæœ‰ä¸€å€‹ç­–ç•¥ï¼Œæ¡ç”¨ `market_data_cache[symbol]` å„²å­˜ï¼Œä¸æœƒæœ‰è¡çª

#### æœŸè²¨åˆç´„è‡ªå‹•è¿‘æœˆé¸æ“‡

ç³»çµ±åœ¨ `get_contract()` æ–¹æ³•ä¸­**è‡ªå‹•é¸æ“‡è¿‘æœˆåˆç´„**ï¼š

```python
near_month_map = {
    "TXF": "TXFR1",
    "MXF": "MXFR1", 
    "TMF": "TMFR1",
}

if symbol in near_month_map:
    symbol = near_month_map[symbol]
```

**é‹ä½œæ–¹å¼**ï¼š
1. ç”¨æˆ¶è¼¸å…¥åŸºæœ¬ä»£ç¢¼ï¼ˆå¦‚ "TXF"ï¼‰
2. ç³»çµ±è‡ªå‹•è½‰æ›ç‚ºè¿‘æœˆåˆç´„ä»£ç¢¼ï¼ˆå¦‚ "TXFR1"ï¼‰
3. å–å¾—è¿‘æœˆåˆç´„é€²è¡Œäº¤æ˜“

**å„ªé»**ï¼š
- ç„¡éœ€ç”¨æˆ¶æŒ‡å®šåˆ°æœŸæ—¥
- è¿‘æœˆåˆç´„æµå‹•æ€§æœ€å¥½
- åˆç´„åˆ°æœŸæ™‚è‡ªå‹•ä½¿ç”¨æ–°çš„è¿‘æœˆåˆç´„

#### æ”¯æ´å•†å“é™åˆ¶

**ç³»çµ±ç›®å‰åƒ…æ”¯æ´ä»¥ä¸‹ä¸‰ç¨®æœŸè²¨å•†å“**ï¼š

| æœŸè²¨ä»£ç¢¼ | åç¨± | é»å€¼ |
|---------|------|------|
| TXF | è‡ºè‚¡æœŸè²¨ï¼ˆå¤§å°ï¼‰| 200å…ƒ/é» |
| MXF | å°å‹è‡ºæŒ‡ï¼ˆå°å°ï¼‰| 50å…ƒ/é» |
| TMF | å¾®å‹è‡ºæŒ‡ï¼ˆå¾®å°ï¼‰| 10å…ƒ/é» |

**é™åˆ¶åŸå› **ï¼š
1. ç°¡åŒ–ç³»çµ±åˆæœŸè¤‡é›œåº¦
2. èšç„¦æ–¼æµå‹•æ€§æœ€å¥½çš„ä¸‰å€‹å•†å“
3. é¿å…ç”¨æˆ¶è¼¸å…¥éŒ¯èª¤å•†å“ä»£ç¢¼

**é©—è­‰æ©Ÿåˆ¶**ï¼š
- ç”¨æˆ¶è¼¸å…¥éå…è¨±çš„ä»£ç¢¼æ™‚ï¼Œç³»çµ±æœƒé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦åˆ—å‡ºå¯ç”¨ä»£ç¢¼
- ä¾‹å¦‚è¼¸å…¥ "T5F" æ™‚æœƒé¡¯ç¤ºï¼š
  ```
  âŒ ç„¡æ•ˆçš„æœŸè²¨ä»£ç¢¼ï¼šT5F
  å¯ç”¨ä»£ç¢¼ï¼šTXF(è‡ºè‚¡æœŸè²¨), MXF(å°å‹è‡ºæŒ‡), TMF(å¾®å‹è‡ºæŒ‡)
  ```

#### å›æ¸¬ç¸¾æ•ˆè¨ˆç®—

å›æ¸¬ç³»çµ±åœ¨è¨ˆç®—ç¸¾æ•ˆæ™‚æœƒä½¿ç”¨åˆç´„ä¹˜æ•¸å’Œå›ºå®šæ‰‹çºŒè²»ï¼š

```python
# åˆç´„ä¹˜æ•¸ï¼ˆé»å€¼ï¼‰
contract_multiplier_map = {
    "TXF": 200,  # è‡ºè‚¡æœŸè²¨
    "MXF": 50,   # å°å‹è‡ºæŒ‡
    "TMF": 10,   # å¾®å‹è‡ºæŒ‡
}
contract_multiplier = contract_multiplier_map.get(symbol, 1)

# å›ºå®šæ‰‹çºŒè²»ï¼ˆæ¯å£ï¼‰
fixed_commission_map = {
    "TXF": 40,  # å¤§å°
    "MXF": 20,  # å°å°
    "TMF": 14,  # å¾®å°
}
commission_per_trade = fixed_commission_map.get(symbol, 0)

# è¨ˆç®—ç¸½æ‰‹çºŒè²»ï¼ˆé–‹å€‰+å¹³å€‰ï¼‰
total_commission = trade_count * 2 * commission_per_trade

# ç¸½æç›Š = å ±é…¬ç‡% Ã— åˆå§‹è³‡é‡‘ Ã— åˆç´„ä¹˜æ•¸ - æ‰‹çºŒè²»
total_pnl = initial_capital * total_return / 100 * contract_multiplier - total_commission
```

**èªªæ˜**ï¼š
- Shioaji API çš„ `unit` æ¬„ä½è¿”å›å€¼ç‚º 1ï¼Œä¸æ˜¯å¯¦éš›é»å€¼
- å› æ­¤ç³»çµ±ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„æ˜ å°„è¡¨ä¾†ç²å–æ­£ç¢ºçš„åˆç´„ä¹˜æ•¸
- å›ºå®šæ‰‹çºŒè²»ï¼šé–‹å€‰å’Œå¹³å€‰å„æ”¶å–ä¸€æ¬¡
- é€™å€‹ä¹˜æ•¸æœƒå½±éŸ¿ç¸½æç›Šã€å¹³å‡äº¤æ˜“æç›Šç­‰ä»¥é‡‘é¡è¨ˆç®—çš„æŒ‡æ¨™
- å ±é…¬ç‡ (%) ä¸å—å½±éŸ¿
  ```
  âŒ ç„¡æ•ˆçš„æœŸè²¨ä»£ç¢¼ï¼šT5F
  å¯ç”¨ä»£ç¢¼ï¼šTXF(è‡ºè‚¡æœŸè²¨), MXF(å°å‹è‡ºæŒ‡), TMF(å¾®å‹è‡ºæŒ‡)
  ```
- åˆç´„åˆ°æœŸæ™‚è‡ªå‹•ä½¿ç”¨æ–°çš„è¿‘æœˆåˆè™Ÿ

### 4.11 MarketData å¿«å–æ¶æ§‹

#### å…©å¥—å¿«å–ç³»çµ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Shioaji API                              â”‚
â”‚                  (çœŸå¯¦å¸‚å ´å ±åƒ¹ / æ­·å²Kæ£’)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MarketDataService     â”‚    â”‚      StrategyRunner            â”‚
â”‚   (price_cache)         â”‚    â”‚   (market_data_cache)          â”‚
â”‚   - æœ€æ–°åƒ¹æ ¼å¿«å–        â”‚    â”‚   - Kæ£’æ­·å²è³‡æ–™               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| å¿«å– | ä½ç½® | ç”¨é€” | è³‡æ–™ä¾†æº |
|------|------|------|----------|
| `price_cache` | `data_service.py` | åƒ¹æ ¼å¿«å– | å³æ™‚å ±åƒ¹ |
| `market_data_cache` | `runner.py` | Kæ£’å¿«å– | æ­·å²Kæ£’ + å³æ™‚å ±åƒ¹ |

#### MarketData è³‡æ–™çµæ§‹

```python
class MarketData:
    symbol: str                           # æœŸè²¨ä»£ç¢¼
    timestamps: List[datetime]            # æ™‚é–“åºåˆ—
    open_prices: List[float]              # é–‹ç›¤åƒ¹
    high_prices: List[float]              # æœ€é«˜åƒ¹
    low_prices: List[float]               # æœ€ä½åƒ¹
    close_prices: List[float]             # æ”¶ç›¤åƒ¹
    volumes: List[float]                  # æˆäº¤é‡
    current_price: float                  # æœ€æ–°åƒ¹æ ¼
```

#### å¿«å–é‹ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç­–ç•¥å•Ÿå‹•æ™‚ (start_strategy)                              â”‚
â”‚    ensure_sufficient_data()                                â”‚
â”‚    â†’ get_kbars() å–å¾—æ­·å²Kæ£’                               â”‚
â”‚    â†’ update_market_data() å­˜å…¥å¿«å–                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å³æ™‚å ±åƒ¹ (subscribe_quote)                              â”‚
â”‚    â†’ åƒ¹æ ¼æ›´æ–°è§¸ç™¼ update_market_data()                     â”‚
â”‚    â†’ æ–°tickå¯«å…¥å¿«å–ï¼Œç¶­æŒæœ€å¤š500æ ¹Kæ£’                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ¯60ç§’åŸ·è¡Œ (run_all_strategies)                        â”‚
â”‚    execute_strategy_llm()                                  â”‚
â”‚    â†’ å¾ market_data_cache[symbol] å–æœ€æ–°Kæ£’              â”‚
â”‚    â†’ å‚³å…¥ StrategyExecutor.execute_bar()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é—œéµæ–¹æ³•

| æ–¹æ³• | è¡Œè™Ÿ | åŠŸèƒ½ |
|------|------|------|
| `update_market_data()` | `runner.py:393` | æ›´æ–° K æ£’åˆ°å¿«å– |
| `ensure_sufficient_data()` | `runner.py:55` | ç¢ºä¿æœ‰è¶³å¤ æ­·å²è³‡æ–™ |
| `get_market_data()` | `runner.py:424` | å–å¾—æŸ symbol çš„ MarketData |

#### å¿«å–ç¶­è­·

- æœ€å¤šä¿ç•™ **500 æ ¹** K æ£’
- è¶…éè‡ªå‹•æˆªæ–·èˆŠè³‡æ–™ (`runner.py:414-422`)

### 4.12 ç­–ç•¥ç¨‹å¼ç¢¼é©—è­‰æµç¨‹

ï¼ˆè¦‹ä¸Šæ–¹ç« ç¯€ï¼‰

---

### 4.13 BacktestEngine å›æ¸¬ç³»çµ±

#### 4.13.1 æ¦‚è¿°

ç³»çµ±ä½¿ç”¨ **backtesting.py** å‡½å¼åº«åŸ·è¡Œæ­·å²å›æ¸¬ï¼Œæä¾›ç”¨æˆ¶åœ¨å•Ÿç”¨ç­–ç•¥å‰åƒè€ƒéå»ç¸¾æ•ˆã€‚

#### 4.13.2 æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   BacktestEngine                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è§£æç­–ç•¥ä»£ç¢¼ â†’ æå–æŒ‡æ¨™éœ€æ±‚ (RSI/MACD/SMA/BB)       â”‚
â”‚  2. å–å¾—æ­·å² K æ£’ (Shioaji) â†’ pandas DataFrame         â”‚
â”‚  3. ç”¨ pandas_ta è¨ˆç®—æŒ‡æ¨™                               â”‚
â”‚  4. å»ºç«‹ backtesting.py Backtest + ç­–ç•¥           â”‚
â”‚  5. åŸ·è¡Œå›æ¸¬ â†’ è¼¸å‡ºç¸¾æ•ˆå ±å‘Š                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.13.3 Timeframe èˆ‡å›æ¸¬æœŸé–“å°ç…§è¡¨

| Timeframe | å›æ¸¬æœŸé–“ | Kæ£’æ•¸ï¼ˆä¼°ï¼‰| èªªæ˜ |
|-----------|---------|-----------|------|
| `1m` | 1é€± | ~2,000-2,500 | åˆ†é˜é »ç‡ï¼Œç¸®çŸ­ä»¥å…¼é¡§æ•ˆèƒ½ |
| `5m` | 2é€± | ~1,000 | åˆ†é˜é »ç‡ |
| `15m` | 1å€‹æœˆ | ~600-700 | åˆ†é˜é »ç‡ |
| `30m` | 1å€‹æœˆ | ~300-340 | åˆ†é˜é »ç‡ |
| `60m` / `1h` | 3å€‹æœˆ | ~1,200-1,400 | å°æ™‚é »ç‡ |
| `1d` | 1å¹´ | ~250 | æ—¥é »ç‡ |

#### 4.13.4 æŒ‡æ¨™æ•´åˆæ–¹å¼

ç³»çµ±ä½¿ç”¨ **pandas_ta é å…ˆè¨ˆç®—æŒ‡æ¨™**ï¼Œå†å‚³çµ¦ backtesting.py åŸ·è¡Œå›æ¸¬ï¼š

```python
# 1. æ ¹æ“šç­–ç•¥ä»£ç¢¼æå–æŒ‡æ¨™éœ€æ±‚
def extract_indicators_from_code(code: str) -> list:
    indicators = []
    if "RSI" in code:
        indicators.append('rsi')
    if "MACD" in code:
        indicators.extend(['macd', 'macd_signal', 'macd_hist'])
    # ...
    return indicators

# 2. ç”¨ pandas_ta è¨ˆç®—æŒ‡æ¨™
df['rsi'] = ta.rsi(df['close'], length=14)
df['macd'] = ta.macd(df['close'])

# 3. backtesting.py è®€å–é å…ˆè¨ˆç®—çš„æŒ‡æ¨™
class BacktestStrategy(bt.Strategy):
    def next(self):
        if self.data.rsi[0] < 30:
            self.buy()
```

#### 4.13.5 è¨‚å–®é¡å‹

| ç’°å¢ƒ | è¨‚å–®é¡å‹ | èªªæ˜ |
|------|---------|------|
| **å›æ¸¬** | å¸‚åƒ¹å–®ï¼ˆä¸‹ä¸€æ ¹ K æ£’é–‹ç›¤åƒ¹ï¼‰| æ¨¡æ“¬å¸‚åƒ¹å–®æˆäº¤ï¼Œæœ€ä¿å®ˆçš„ä¼°è¨ˆ |
| **å¯¦ç›¤** | MKT + ROD | å¸‚åƒ¹å–®ï¼Œç•¶æ—¥æœ‰æ•ˆ |

#### 4.13.6 è¼¸å‡ºç¸¾æ•ˆå ±å‘Šæ ¼å¼

```
ğŸ“Š æ­·å²å›æ¸¬å ±å‘Š (ç­–ç•¥åç¨±)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“… å›æ¸¬æœŸé–“: 2025-01-01 ~ 2025-02-01 (1å€‹æœˆ)
ğŸ“ˆ åˆå§‹è³‡é‡‘: 1,000,000 NTD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’° ç¸½æç›Š: +85,000 (+8.5%)
ğŸ’µ æœ€å¤§è³‡é‡‘å›æ’¤: -32,000 (-3.2%)
ğŸ“Š Sharpe Ratio: 1.72
ğŸ“Š SQN: 2.1 (Average)
ğŸ“Š äº¤æ˜“æ¬¡æ•¸: 18
âœ… ç²åˆ©äº¤æ˜“: 12
âŒ è™§æäº¤æ˜“: 6
ğŸ“ˆ å‹ç‡: 66.7%
ğŸ“Š ç²åˆ©å› å­: 2.15
ğŸ“Š å¹³å‡äº¤æ˜“: +4,722
ğŸ“Š æœ€å¤§å–®ç­†ç²åˆ©: +12,500
ğŸ“Š æœ€å¤§å–®ç­†è™§æ: -6,800
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ éå»ç¸¾æ•ˆä¸ä»£è¡¨æœªä¾†çµæœï¼Œåƒ…ä¾›åƒè€ƒ
```

#### 4.13.7 ä½¿ç”¨æ™‚æ©Ÿ

1. **ç¨ç«‹æŒ‡ä»¤**ï¼šç”¨æˆ¶è¼¸å…¥ `å›æ¸¬ <ID>` æˆ– `backtest <ID>` æŸ¥çœ‹è©³ç´°å›æ¸¬å ±å‘Šï¼ˆåŒ…å«åœ–è¡¨ï¼‰
2. **å•Ÿç”¨å‰é¡¯ç¤º**ï¼šç”¨æˆ¶è¼¸å…¥ `å•Ÿç”¨ <ID>` æ™‚ï¼Œç³»çµ±è‡ªå‹•é¡¯ç¤ºæ­·å²å›æ¸¬é—œéµæŒ‡æ¨™

#### 4.13.8 é—œéµé¡åˆ¥

```python
class BacktestEngine:
    """backtesting.py å›æ¸¬å¼•æ“"""
    
    TIMEFRAME_CONFIG = {
        "1m": (7, "1é€±"),
        "5m": (14, "2é€±"),
        "15m": (30, "1å€‹æœˆ"),
        "30m": (30, "1å€‹æœˆ"),
        "60m": (90, "3å€‹æœˆ"),
        "1h": (90, "3å€‹æœˆ"),
        "1d": (365, "1å¹´"),
    }
    
    async def run_backtest(
        self,
        strategy_code: str,
        class_name: str,
        symbol: str,
        timeframe: str = "15m",
        initial_capital: float = 1_000_000,
        commission: float = 0.0002
    ) -> dict:
        """åŸ·è¡Œæ­·å²å›æ¸¬"""
        # 1. æ ¹æ“š timeframe æ±ºå®šå›æ¸¬æœŸé–“
        # 2. å–å¾—æ­·å² K æ£’
        # 3. ç·¨è­¯ç­–ç•¥
        # 4. å»ºç«‹ Cerebro + Data Feed + Strategy + Analyzers
        # 5. åŸ·è¡Œå›æ¸¬
        # 6. è§£æçµæœ
        # 7. ç”¢ç”Ÿç¸¾æ•ˆå ±å‘Š
```

#### 4.13.9 Analyzers é…ç½®

```python
cerebro.addanalyzer(bt.analyzers.SharpeRatio, _name='sharpe')
cerebro.addanalyzer(bt.analyzers.DrawDown, _name='drawdown')
cerebro.addanalyzer(bt.analyzers.Returns, _name='returns')
cerebro.addanalyzer(bt.analyzers.TradeAnalyzer, _name='trades')
cerebro.addanalyzer(bt.analyzers.SQN, _name='sqn')
cerebro.addanalyzer(bt.analyzers.AnnualReturn, _name='annual_return')
```

---

## 6. éƒ¨ç½²æ¶æ§‹

### 6.1 å–®æ©Ÿéƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Linux / Windows           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Python Application     â”‚   â”‚
â”‚  â”‚         (main.py)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚    â”‚         â”‚         â”‚           â”‚
â”‚    â–¼         â–¼         â–¼           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚API  â”‚  â”‚Tlgm â”‚  â”‚LLM  â”‚        â”‚
â”‚ â”‚Key  â”‚  â”‚Bot  â”‚  â”‚API  â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç³»çµ±éœ€æ±‚

| é …ç›® | æœ€ä½éœ€æ±‚ |
|------|----------|
| Python | 3.10+ |
| è¨˜æ†¶é«” | 2GB |
| ç¡¬ç¢Ÿ | 1GB |
| ç¶²è·¯ | ç©©å®šç¶²è·¯é€£ç·š |

---

## 7. å®‰å…¨æ©Ÿåˆ¶

### 7.1 é¢¨æ§æª¢æŸ¥é †åº

```
ä¸‹å–®è«‹æ±‚
    â”‚
    â–¼
1. æª¢æŸ¥ä¸‹å–®é »ç‡ (æ¯åˆ†é˜æœ€å¤š5æ¬¡)
    â”‚
    â–¼
2. æª¢æŸ¥æœ€å¤§å£æ•¸ (é è¨­10å£)
    â”‚
    â–¼
3. æª¢æŸ¥å–®æ—¥è™§æ (é è¨­50000å…ƒ)
    â”‚
    â–¼
4. æª¢æŸ¥åƒ¹æ ¼åˆç†æ€§
    â”‚
    â–¼
é€šé â†’ åŸ·è¡Œä¸‹å–®
å¤±æ•— â†’ é˜»æ“‹ä¸¦å›å ±åŸå› 
```

### 7.2 æ–·ç·šè™•ç†

- è‡ªå‹•åµæ¸¬é€£ç·šç‹€æ…‹
- æœ€å¤šé‡é€£50æ¬¡
- æ¯æ¬¡é‡é€£é–“éš”5ç§’
- æ–·ç·šæ™‚ç™¼é€ Telegram é€šçŸ¥

### 7.3 LLM å¤±æ•—è™•ç†

ç•¶ LLM ç­–ç•¥ç”Ÿæˆå¤±æ•—æ™‚ï¼š

1. ç³»çµ±è¨˜éŒ„éŒ¯èª¤æ—¥èªŒ
2. ç­–ç•¥ä¸æœƒåŸ·è¡Œ
3. ç™¼é€ Telegram é€šçŸ¥çµ¦ç”¨æˆ¶
4. ç”¨æˆ¶å¯ä¿®æ”¹ç­–ç•¥æè¿°å¾Œé‡æ–°å˜—è©¦

---

## 8. ç‰ˆæœ¬è³‡è¨Š

| ç‰ˆæœ¬ | æ—¥æœŸ | èªªæ˜ |
|------|------|------|
| 1.0.0 | 2026-01 | åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æ´3å€‹ç­–ç•¥ |
| 2.0.0 | 2026-02 | æ–°å¢ LLM ç­–ç•¥ç”Ÿæˆå™¨èˆ‡ç­–ç•¥æ¡†æ¶ |
| 2.1.0 | 2026-02 | æ–°å¢ Telegram Bot æ¥æ”¶æ©Ÿåˆ¶ |
| 3.0.0 | 2026-02 | æ–°å¢è‡ªæˆ‘å„ªåŒ–ç³»çµ± - ç›®æ¨™è¨­å®šã€è¨Šè™Ÿè¨˜éŒ„ã€ç¸¾æ•ˆåˆ†æ |
| 3.1.0 | 2026-02 | æ–°å¢è‡ªæˆ‘å„ªåŒ–ç³»çµ± - LLM ç­–ç•¥å¯©æŸ¥ |
| 3.2.0 | 2026-02 | æ–°å¢è‡ªæˆ‘å„ªåŒ–ç³»çµ± - åŠè‡ªå‹•å„ªåŒ–å¾ªç’° |
| 3.3.0 | 2026-02 | æ–°å¢è‡ªå‹• LLM Review æ’ç¨‹åŠŸèƒ½ |
| 3.4.0 | 2026-02 | æ–°å¢ç‰ˆæœ¬åŒ–è¨Šè™Ÿå„²å­˜ï¼Œç­–ç•¥æ›´æ–°æ™‚è‡ªå‹•éå¢ç‰ˆæœ¬ |
| 3.5.0 | 2026-02 | é‡æ§‹å„²å­˜ç³»çµ±ï¼Œæ¡ç”¨ per-strategy çµæ§‹ |
| 3.6.0 | 2026-02 | æ–°å¢ Fallback å‘½ä»¤è™•ç†æ©Ÿåˆ¶ï¼Œç¢ºä¿åŸºæœ¬å‘½ä»¤åŸ·è¡ŒæˆåŠŸ |
| 3.7.0 | 2026-02 | æ–°å¢ Markdown æ¸…ç†æ©Ÿåˆ¶èˆ‡ç›´æ¥è™•ç†è¼¸å…¥å„ªåŒ– |
| 3.8.0 | 2026-02 | æ–°å¢ BacktestEngine æ­·å²å›æ¸¬ç³»çµ± |
| 3.9.0 | 2026-02 | æ–°å¢å›æ¸¬åœ–è¡¨ç”Ÿæˆèˆ‡ Telegram åœ–ç‰‡ç™¼é€åŠŸèƒ½ |
| 3.10.0 | 2026-02 | æ–°å¢ delete æŒ‡ä»¤èˆ‡å›æ¸¬åœ–ç‰‡æ¸…ç†åŠŸèƒ½ |
| **3.11.0** | **2026-03** | **æ–°å¢äº¤æ˜“æ—¥èªŒç³»çµ±ï¼ˆTradeLogStoreï¼‰ï¼Œæ”¯æ´é‡è¦äº¤æ˜“è¨Šæ¯é¡¯ç¤ºèˆ‡éæ¿¾** |
| **3.12.0** | **2026-03** | **ç³»çµ±æ—¥èªŒé‡å‘½åï¼štrading.log â†’ system.logï¼Œçµ±ä¸€å¹³å€‰æµç¨‹** |
| **3.13.0** | **2026-03** | **è¨‚å–®æŸ¥è©¢é é¢æ–°å¢åŸå› æ¬„ä½ï¼Œé¢¨æ§ç‹€æ…‹é¡¯ç¤ºå¯¦éš›éƒ¨ä½æ•¸é‡** |
| **3.14.0** | **2026-03** | **åœææª¢æŸ¥çµ±ä¸€ä½¿ç”¨ strategy_runner å¸‚å ´æ•¸æ“šï¼Œç¢ºä¿èˆ‡ç­–ç•¥æ±ºç­–åƒ¹æ ¼ä¸€è‡´** |
| **3.15.0** | **2026-03** | **åˆªé™¤ç­–ç•¥æ™‚é€£å¸¶åˆªé™¤ backtests ç›®éŒ„ä¸‹æ‰€æœ‰ç›¸é—œæª”æ¡ˆ** |
| **3.16.0** | **2026-03** | **æ¨¡æ“¬åˆç´„åƒ¹æ ¼çµ±ä¸€ï¼šget_contract() èˆ‡ MockTrade.filled_price éƒ½ä½¿ç”¨ strategy_runner å‹•æ…‹åƒ¹æ ¼ï¼Œè§£æ±ºä¸‹å–®æˆäº¤åƒ¹å›ºå®šå•é¡Œ** |
| **3.17.0** | **2026-03** | **æ¨¡æ“¬åƒ¹æ ¼çµ±ä¸€åŒ–ï¼šå›æ¸¬Kç·š(_generate_mock_kbars)èˆ‡å¯¦æ™‚äº¤æ˜“(_simulate_price_updates)çµ±ä¸€ä½¿ç”¨ ShioajiClient.TIMEFRAME_VOLATILITYï¼Œæ ¹æ“šç­–ç•¥ timeframe è‡ªå‹•èª¿æ•´æ³¢å‹•ç‡(1m:0.03%~1d:1.2%)** |

---

## 9. æŠ€è¡“æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹åƒé–±ï¼š
- [åŠŸèƒ½èªªæ˜](./Features.md)
- [Userä½¿ç”¨æ‰‹å†Š](./User_Manual.md)
