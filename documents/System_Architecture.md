# AI 期貨交易系統 - 系統架構說明

## 1. 系統概述

### 1.1 系統目標

本系統是一個基於 AI Agent 的期貨自動交易系統，透過永豐期貨 Shioaji API 進行交易，並整合 LLM 大語言模型實現自然語言交易操作與策略生成。

### 1.2 技術堆疊

| 層面 | 技術 |
|------|------|
| 交易 API | Shioaji (永豐期貨) |
| 程式語言 | Python 3.10+ |
| AI Agent | Nanobot 架構概念 |
| LLM | OpenRouter / OpenAI / Anthropic / DeepSeek / Ollama (本地) |
| 技術指標 | pandas_ta |
| 通知 | Telegram Bot |
| 資料儲存 | JSON 檔案 |

---

## 2. 系統架構圖

### 2.1 整體架構 (8層)

```
┌─────────────────────────────────────────────────────────────────────┐
│                        User Layer (用戶層)                          │
│                  Telegram / Command Line                           │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Agent Layer (AI Agent 層)                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │  Trading Tools  │  │ System Prompt   │  │  LLM Provider   │    │
│  │  - place_order  │  │                 │  │                 │    │
│  │  - get_position│  │  交易規則       │  │  GPT/Claude     │    │
│  │  - get_perform │  │  策略定義       │  │  DeepSeek       │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Engine Layer (引擎層) - 策略執行                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │ LLM Generator   │  │ TradingStrategy │  │ StrategyExecutor│    │
│  │  策略代碼生成   │  │    策略框架     │  │   策略執行器     │    │
│  │  (自由格式)     │  │ (TradingStrategy)│ │                 │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Business Layer (業務層)                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
│  │ Strategy Manager│  │ Position Manager│  │  Order Manager  │      │
│  │   管理3個策略    │  │  按策略分開部位  │  │    訂單管理     │      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘      │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Risk Layer (風控層)                            │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                    Risk Manager                             │    │
│  │  - 單日最大虧損檢查  - 最大部位檢查   - 頻率限制           │    │
│  │  - 停損止盈監控     - 異常訂單檢查                         │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Adapter Layer (適配層)                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │ Shioaji Client  │  │ Connection Mgr   │  │ Order Callback  │    │
│  │                 │  │  斷線重連機制    │  │                 │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    API Layer (Shioaji API)                         │
│                    永豐期貨 API                                     │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Market Data (市場)                                │
│                    期貨交易所                                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 策略執行流程

```
用戶策略描述
     │
     ▼
┌─────────────────┐
│ LLM Generator   │ ◄─── 將描述轉換為策略程式碼
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Strategy Class  │ ◄─── 繼承 TradingStrategy
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ StrategyExecutor│ ◄─── 執行策略的 on_bar()
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│ buy   │ │ sell  │
│ close │ │ hold  │
└───────┘ └───────┘
```

### 2.3 數據流向圖

```
用戶指令 (Telegram)
      │
      ▼
┌─────────────────┐
│  Agent Loop     │ ◄─── LLM 分析用戶意圖
└────────┬────────┘
          │
          ▼
┌─────────────────┐
│  Tool 選擇      │ ◄─── 根據意圖選擇工具
└────────┬────────┘
          │
     ┌────┴────┐
     │         │
     ▼         ▼
 ┌───────┐ ┌───────┐
 │ 風控  │ │ 交易  │
 │ 檢查  │ │ 執行  │
 └───┬───┘ └───┬───┘
     │         │
     │    ┌────┴────┐
     │    │         │
     ▼    ▼         ▼
 ┌─────────┐  ┌─────────┐
 │ 、風控阻擋 │  │ Shioaji│
 └─────────┘  │  API   │
              └────────┘
```

---

## 3. 核心模組說明

### 3.1 API 層 (src/api/)

| 檔案 | 說明 |
|------|------|
| `shioaji_client.py` | Shioaji API 封裝，包含登入、下單、取得部位等 |
| `connection.py` | 連線管理，自動重連機制 |
| `order_callback.py` | 訂單/報價回調處理 |

### 3.2 交易層 (src/trading/)

| 檔案 | 說明 |
|------|------|
| `strategy.py` | 策略類別 (含 LLM 生成程式碼欄位) |
| `strategy_manager.py` | 策略管理器，管理3個策略 |
| `position.py` | 部位類別 |
| `position_manager.py` | 部位管理器，按策略分開追蹤 |
| `order.py` | 訂單類別 |
| `order_manager.py` | 訂單管理器 |

### 3.3 引擎層 (src/engine/)

| 檔案 | 說明 |
|------|------|
| `framework.py` | 策略框架 (TradingStrategy, StrategyExecutor) |
| `llm_generator.py` | LLM 策略生成器 |
| `runner.py` | 策略執行協調器 |

### 3.4 市場數據層 (src/market/)

| 檔案 | 說明 |
|------|------|
| `price_cache.py` | 價格快取 |
| `data_service.py` | 市場資料服務 |

### 3.5 風控層 (src/risk/)

| 檔案 | 說明 |
|------|------|
| `risk_manager.py` | 風控檢查、停損止盈監控 |

### 3.6 通知層 (src/notify/)

| 檔案 | 說明 |
|------|------|
| `telegram.py` | Telegram 機器人通知 |

### 3.7 Agent 層 (src/agent/)

| 檔案 | 說明 |
|------|------|
| `tools.py` | AI Agent 交易工具集 (含策略管理工具) |
| `prompts.py` | 系統提示詞 |
| `providers.py` | LLM 提供者 (Ollama/OpenAI/Anthropic/DeepSeek/OpenRouter) |

#### Agent Tools 一覽

| Tool 名稱 | 功能 |
|-----------|------|
| `create_strategy` | 建立新策略 |
| `update_strategy_prompt` | 更新策略描述 |
| `delete_strategy` | 刪除策略 |
| `enable_strategy` | 啟用策略 |
| `disable_strategy` | 停用策略 |
| `place_order` | 手動下單 |
| `close_position` | 平倉 |
| `get_positions` | 取得部位 |
| `get_strategies` | 取得策略列表 |
| `get_performance` | 取得績效 |

---

## 4. 策略框架說明

### 4.1 TradingStrategy 抽象類別

所有 LLM 生成的策略必須繼承 `TradingStrategy`：

```python
from src.engine.framework import TradingStrategy, BarData

class MyStrategy(TradingStrategy):
    def __init__(self, symbol: str):
        super().__init__(symbol)
    
    def on_bar(self, bar: BarData) -> str:
        # 策略邏輯
        return 'hold'  # 或 'buy', 'sell', 'close'
```

### 4.2 可用屬性

| 屬性 | 說明 |
|------|------|
| `self.position` | 當前部位 (正=多單，負=空單，0=無部位) |
| `self.entry_price` | 進場價格 |
| `self.context` | 字典，可儲存自定義狀態 |
| `self.symbol` | 合約代碼 |

### 4.3 可用方法

| 方法 | 說明 |
|------|------|
| `self.get_bars(n)` | 取得最近 n 根 K 棒 |
| `self.get_dataframe(n)` | 取得 pandas DataFrame |
| `self.ta(指標, **參數)` | 使用 pandas_ta 計算技術指標 |

### 4.4 pandas_ta 支援的指標

| 指標 | 說明 | 參數 |
|------|------|------|
| RSI | 相對強弱指標 | period=14 |
| MACD | 指數平滑異同移動平均線 | fast=12, slow=26, signal=9 |
| SMA | 簡單移動平均 | period=20 |
| EMA | 指數移動平均 | period=20 |
| BB | 布林帶 | period=20, std=2.0 |
| ATR | 平均真實波幅 | period=14 |
| STOCH | KD 指標 | period=14 |
| ADX | 平均趨向指標 | period=14 |
| CCI | 商品通道指標 | period=20 |
| OBV | 能量潮 | - |
| VWAP | 成交量加權平均價 | - |
| WILLR | 威廉指標 | period=14 |

---

## 5. 資料儲存

### 5.1 儲存位置

所有資料儲存於 `workspace/` 目錄：

```
workspace/
├── strategies.json      # 3個策略配置 (含 LLM 生成的程式碼)
├── positions.json      # 部位記錄 (按策略分開)
├── orders.json         # 訂單記錄
├── performance.json    # 績效統計
└── logs/
    └── trading.log    # 交易日誌
```

### 5.2 策略配置 (strategies.json)

```json
{
  "strategies": [
    {
      "id": "strategy_001",
      "name": "台指突破策略",
      "symbol": "TXF",
      "prompt": "當RSI低於30買進，高於70賣出",
      "enabled": true,
      "params": {
        "timeframe": "15m",
        "stop_loss": 50,
        "take_profit": 100,
        "position_size": 2
      },
      "strategy_code": "class RSIStrategy(TradingStrategy)...",
      "strategy_class_name": "RSIStrategy",
      "strategy_generated_at": "2024-01-15T10:00:00",
      "strategy_version": 1
    }
  ]
}
```

---

## 6. 部署架構

### 6.1 單機部署

```
┌─────────────────────────────────────┐
│           Linux / Windows           │
│  ┌─────────────────────────────┐   │
│  │      Python Application     │   │
│  │         (main.py)          │   │
│  └─────────────────────────────┘   │
│              │                      │
│    ┌─────────┼─────────┐           │
│    │         │         │           │
│    ▼         ▼         ▼           │
│ ┌─────┐  ┌─────┐  ┌─────┐        │
│ │API  │  │Tlgm │  │LLM  │        │
│ │Key  │  │Bot  │  │API  │        │
│ └─────┘  └─────┘  └─────┘        │
└─────────────────────────────────────┘
```

### 6.2 系統需求

| 項目 | 最低需求 |
|------|----------|
| Python | 3.10+ |
| 記憶體 | 2GB |
| 硬碟 | 1GB |
| 網路 | 穩定網路連線 |

---

## 7. 安全機制

### 7.1 風控檢查順序

```
下單請求
    │
    ▼
1. 檢查下單頻率 (每分鐘最多5次)
    │
    ▼
2. 檢查最大口數 (預設10口)
    │
    ▼
3. 檢查單日虧損 (預設50000元)
    │
    ▼
4. 檢查價格合理性
    │
    ▼
通過 → 執行下單
失敗 → 阻擋並回報原因
```

### 7.2 斷線處理

- 自動偵測連線狀態
- 最多重連50次
- 每次重連間隔5秒
- 斷線時發送 Telegram 通知

### 7.3 LLM 失敗處理

當 LLM 策略生成失敗時：

1. 系統記錄錯誤日誌
2. 策略不會執行
3. 發送 Telegram 通知給用戶
4. 用戶可修改策略描述後重新嘗試

---

## 8. 版本資訊

| 版本 | 日期 | 說明 |
|------|------|------|
| 1.0.0 | 2026-01 | 初始版本 |
| 2.0.0 | 2026-02 | 新增 LLM 策略生成器與策略框架 |

---

## 9. 技術支援

如有問題，請參閱：
- [功能說明](./Features.md)
- [User使用手冊](./User_Manual.md)
