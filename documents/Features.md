# AI 期貨交易系統 - 功能說明

## 啟動方式

### 命令行參數

```bash
# 一般啟動（需要 Shioaji 登入）
python main.py

# 模擬模式（跳過 API 登入，用於測試）
python main.py --simulate

# CLI 模式（本地命令行操作）
python main.py --cli

# 模擬 + CLI 模式
python main.py --simulate --cli

# 指定配置文件
python main.py --config custom.yaml
```

| 參數 | 說明 |
|------|------|
| `--simulate` | 模擬模式，跳過 Shioaji API 登入 |
| `--cli` | 啟用本地命令行界面 |
| `--config` | 指定配置文件路徑 |

---

## 1. 核心功能

### 1.1 Fallback 命令處理機制

系統採用 **fallback 機制**來處理基本命令，確保執行成功：

#### 設計原理

傳統的 LLM Agent 依賴 LLM 調用工具（Tool Calling），但有時 LLM 會忘記調用工具或錯誤判斷用戶意圖，導致命令無法執行。

#### 實現方式

在 `main.py` 的 `llm_process_command()` 函數中添加正則表達式匹配，直接調用對應函數：

```python
# 直接處理 enable/disable 命令
enable_match = re.match(r'^enable\s+(\w+)$', command_stripped)
disable_match = re.match(r'^disable\s+(\w+)$', command_stripped)

if enable_match:
    strategy_id = enable_match.group(1).upper()
    result = self.trading_tools.enable_strategy(strategy_id)
    return result

# 基本查詢命令直接調用
if command_stripped in ["positions", "部位", "持倉"]:
    result = self.trading_tools.get_positions()
    return result
```

#### 支援的命令

| 命令 | 處理方式 |
|------|---------|
| `status` | 直接調用 `get_system_status()` |
| `positions` / `部位` / `持倉` | 直接調用 `get_positions()` |
| `strategies` / `策略` | 直接調用 `get_strategies()` |
| `performance` / `績效` / `表現` | 直接調用 `get_performance()` |
| `risk` / `風控` / `風險` | 直接調用 `get_risk_status()` |
| `orders` / `訂單` / `委託` | 直接調用 `get_order_history()` |
| `new` / `新對話` / `新會話` | 清除對話歷史 |
| `help` / `幫助` | 返回命令列表 |
| `enable <ID>` | 直接調用 `enable_strategy()` |
| `disable <ID>` | 直接調用 `disable_strategy()` |

#### 優勢

1. **可靠性**：基本命令一定會執行，不依賴 LLM 工具調用
2. **速度**：直接函數調用比 LLM 推理更快
3. **容錯**：複雜的自然語言仍交給 LLM 處理

#### 設計原則

- 簡單、明確的命令 → fallback 直接處理
- 複雜的自然語言 → 交給 LLM 處理（如建立策略、修改策略）

### 1.1 策略類型：兩階段執行

系統支援兩種策略執行模式：

#### A. LLM 策略生成（主要模式）
- 用戶輸入自然語言策略描述
- LLM 生成完整策略程式碼
- 策略繼承 `TradingStrategy` 框架
- 支援任意複雜邏輯
- LLM 失敗時策略暫停執行

### 1.2 多策略管理

系統支援多個獨立策略，每個策略具有以下特性：

| 特性 | 說明 |
|------|------|
| 策略 ID | 自動生成 (如 MXFA01, TXFZZZ)，格式：期貨代碼+3位隨機字符 |
| 策略名稱 | 自定義名稱 |
| 期貨合約 | 綁定特定期貨 (TXF/MXF/TMF) |
| 期貨代碼中文名稱 | 從 Shioaji API 動態取得（如 TMF = 微型臺指期貨） |
| 策略 Prompt | AI 交易邏輯描述 |
| K線週期 | 時間週期 (1m/5m/15m/30m/60m/1h/1d) |
| 部位大小 | 每次交易口數 |
| 停損點數 | 停損點數 (0=不啟用) |
| 止盈點數 | 止盈點數 (0=不啟用) |
| 啟用狀態 | enabled = 用戶層面開關，is_running = 系統執行狀態 |

#### 策略 ID 系統

- **格式**：`{期貨代碼}{3位隨機字符}`（如 `MXFA01`, `TXFZZZ`, `EFF12X`）
- **自動生成**：建立策略時自動產生，無需手動指定
- **同合約互斥**：同一期貨代碼只能有一個啟用的策略
- **自動停用**：啟用新版本時，自動停用同代碼的舊版本

#### 策略狀態說明

系統使用兩個狀態屬性：

| 狀態 | 屬性 | 說明 |
|------|------|------|
| 啟用 | `enabled` | 用戶層面開關（啟用/停用） |
| 執行 | `is_running` | 系統執行狀態 |

- **`enabled`**：用戶輸入 `enable <ID>` 時設為 `True`
- **`is_running`**：系統實際開始執行交易時設為 `True`（自動生成策略程式碼、訂閱報價、開始交易）

當策略被啟用但尚未執行時，主迴圈會自動呼叫 `start_strategy()` 來：
1. 設定 `is_running = True`
2. 透過 LLM 生成策略程式碼
3. 訂閱市場報價
4. 開始執行交易

### 1.3 策略版本管理

| 功能 | 說明 |
|------|------|
| 程式碼儲存 | 策略程式碼儲存於 per-strategy JSON 檔案 |
| 版本號 | strategy_version 遞增 |
| Prompt Hash | 檢測策略是否需要重新生成 |
| 自動更新 | Prompt 變更時自動重新生成 |

### 1.4 自動盯盤機制

系統定時執行以下檢查：

| 檢查項目 | 頻率 | 說明 |
|----------|------|------|
| 連線狀態 | 每次迴圈 | 檢查 Shioaji 連線 |
| 部位價格 | 每次迴圈 | 更新部位現價與損益 |
| 停損觸發 | 每次迴圈 | 檢查是否觸發停損 |
| 止盈觸發 | 每次迴圈 | 檢查是否觸發止盈 |
| 當日損益 | 每次迴圈 | 更新風控損益 |

---

## 2. LLM 策略生成功能

### 2.1 Agent 策略管理工具

系統提供多種 Agent Tool 讓用戶透過對話管理策略：

| Tool 名稱 | 功能 | 參數 |
|-----------|------|------|
| `create_strategy` | 建立新策略（手動輸入完整參數，ID自動生成） | name, symbol, prompt, timeframe, quantity, stop_loss, take_profit |
| `create_strategy_by_goal` | **目標驅動建立策略**（自動推斷參數） | goal, symbol |
| `modify_strategy_params` | 修改待確認的策略參數 | modifications |
| `confirm_create_strategy` | 確認或取消建立策略 | confirmed |
| `update_strategy_prompt` | 更新策略描述 | strategy_id, new_prompt |
| `delete_strategy` | 刪除策略（同時刪除相關檔案） | strategy_id |
| `enable_strategy` | 啟用策略（同代碼舊版本自動停用） | strategy_id |
| `disable_strategy` | 停用策略 | strategy_id |

#### 參數驗證

建立策略時會進行以下驗證：

| 參數 | 驗證規則 |
|------|---------|
| name | 不可為空 |
| symbol | 不可為空 (如 TXF, MXF, EFF) |
| prompt | 不可為空 |
| timeframe | 必要參數，可選值：1m, 5m, 15m, 30m, 60m, 1h, 1d |
| quantity | 必須 >= 1 |
| stop_loss | 必須 >= 0 (0=不啟用) |
| take_profit | 必須 >= 0 (0=不啟用) |

**注意**：策略 ID 為自動生成，無需手動提供。

### 2.2 目標驅動策略建立

系統提供兩種建立策略的方式：

#### A. 手動輸入完整參數（原有方式）
用戶提供所有必要參數：
```
建立策略 ID=my_rsi, 名稱=RSI策略, 代碼=TXF, 描述=RSI低於30買入高於70賣出, 週期=15m
```

#### B. 目標驅動（新增功能）
用戶只給出目標，LLM 自動推斷參數：

| 用戶輸入 | LLM 行為 |
|---------|---------|
| 「幫我建立 RSI 策略」 | 詢問期貨代碼 |
| 「設計一個每日賺500元的策略」 | 詢問期貨代碼 |
| 提供 symbol 後 | 推斷參數，展示並要求確認 |
| 「停損改成50點」 | 更新參數，重新展示 |
| 「確認」 | 建立策略 |

##### 目標驅動流程

1. **接收目標**：用戶描述想要的策略
2. **詢問期貨代碼**：若未提供，必須詢問用戶
3. **推斷參數**：自動生成策略名稱、描述、K線週期、停損止盈
4. **展示確認**：將參數展示給用戶，詢問是否正確
5. **修改參數**：用戶可修改部分參數（如「停損改成50點」）
6. **建立完成**：確認後建立策略

##### 可修改的參數

| 參數 | 範例 |
|------|------|
| 停損 | 「停損改成50點」 |
| 止盈 | 「止盈改成100點」 |
| K線週期 | 「週期改成30m」 |
| 交易口數 | 「口數改成2」 |
| 期貨代碼 | 「期貨代碼改成MXF」 |

##### LLM 意圖判斷

| 用戶輸入 | 調用 Tool |
|---------|----------|
| 「幫我建立...」「設計一個...」 | `create_strategy_by_goal` |
| 提供了完整參數（ID+名稱+描述+週期） | `create_strategy` |
| 不確定時 | 優先使用 `create_strategy_by_goal` |

### 2.2 策略 Prompt 輸入

使用者可以透過自然語言描述交易策略，系統會自動生成策略程式碼。

```
範例：
"當RSI低於30買進，RSI高於70賣出"
"漲幅超過5%且成交量是平均的2倍買進"
"買進後，如果遇到漲停板隔日跌-6%以上就平倉"
```

### 2.3 策略複雜度支援

| 策略類型 | 範例 | 支援狀態 |
|----------|------|----------|
| 簡單指標 | RSI < 30 買入 | ✅ 支援 |
| 複合條件 | RSI < 30 且 MACD 金叉 | ✅ 支援 |
| 狀態追蹤 | 漲停後次日跌 6% 平倉 | ✅ 支援 |
| 百分比停損 | 虧損 6% 平倉 | ✅ 支援 |
| 多指標組合 | RSI + MACD + MA | ✅ 支援 |

### 2.4 策略 Prompt 範例

```python
# 範例 1：RSI 策略
"RSI 低於 30 買入，RSI 高於 70 賣出"

# 範例 2：MACD 交叉策略  
"MACD 金叉買入，死叉賣出"

# 範例 3：漲停板策略
"買進後，如果遇到漲停板隔日跌-6%以上就平倉"

# 範例 4：成交量策略
"成交量暴增超過平均2倍且價格上漲買入"

# 範例 5：布林帶策略
"價格跌破布林下軌買入，漲破上軌賣出"
```

### 2.5 LLM 失敗處理

當 LLM 策略生成失敗時：
1. 系統記錄錯誤日誌
2. 策略不會執行
3. 發送 Telegram 通知給用戶
4. 用戶可修改策略描述後重新嘗試

---

## 3. 風控管理

### 3.1 風控項目

| 風控項目 | 預設值 | 說明 |
|----------|--------|------|
| 單日最大虧損 | 50,000 元 | 超過後停止交易 |
| 最大部位口數 | 10 口 | 所有策略合計 |
| 下單頻率 | 5 次/分鐘 | 防止過度交易 |
| 停損啟用 | 開啟 | 可設定關閉 |
| 止盈啟用 | 開啟 | 可設定關閉 |

### 3.2 斷線斷網處理

| 狀況 | 處理方式 |
|------|----------|
| 連線中斷 | 自動偵測，發送通知 |
| 斷線重連 | 最多50次，每次間隔5秒 |
| 重連失敗 | 持續嘗試並通知 |
| API 逾時 | 回傳錯誤，不阻斷系統 |

### 3.3 Telegram 回報

| 事件類型 | 通知內容 |
|----------|----------|
| 系統啟動 | 啟動訊息、模式、策略數 |
| 成交通知 | 合約、方向、數量、價格 |
| 委託取消 | 取消通知 |
| 停損觸發 | 平倉資訊、損益 |
| 止盈觸發 | 平倉資訊、損益 |
| 連線異常 | 斷線/重連通知 |
| 系統錯誤 | 錯誤訊息 |

---

## 4. 技術指標

### 4.1 pandas_ta 支援

系統使用 pandas_ta 計算技術指標（TA-Lib 已被移除）：

| 指標 | 說明 | 參數 |
|------|------|------|
| RSI | 相對強弱指標 | period=14 |
| MACD | 指數平滑異同移動平均線 | fast=12, slow=26, signal=9 |
| SMA | 簡單移動平均 | period=20 |
| EMA | 指數移動平均 | period=20 |
| BB | 布林帶 | period=20, std=2.0 |
| ATR | 平均真實波幅 | period=14 |
| STOCH | KD 指標 | period=14 |
| ADX | 平均趨向指標 | period=14 |
| CCI | 商品通道指標 | period=20 |
| OBV | 能量潮 | - |
| VWAP | 成交量加權平均價 | - |
| WILLR | 威廉指標 | period=14 |

### 4.2 動態 K 棒緩衝

| 指標參數 | 緩衝計算 | 範例 |
|----------|----------|------|
| RSI (14) | period + period | 14 + 14 = 28 根 |
| MA (5, 20) | long_period + long_period | 20 + 20 = 40 根 |
| MACD | 34 + 34 | 68 根 |
| BB (20) | period + period | 20 + 20 = 40 根 |

---

## 5. 交易功能

### 5.1 下單機

| 功能 | 說明 |
|------|------|
| 下單方式 | 限價單 (LMT) |
| 委託類型 | ROD (當日有效) |
| 倉位類型 | 自動 (新倉/平倉) |
| 非阻塞 | 支援非阻塞下單 |

### 5.2 策略上下線控制

| 操作 | 說明 |
|------|------|
| 啟用策略 | 啟動策略並生成程式碼 |
| 停用策略 | 停止策略執行 |
| 重新生成 | 修改 prompt 後自動重新生成 |

### 5.3 停損止盈

| 類型 | 觸發條件 | 動作 |
|------|----------|------|
| 停損 | 虧損達設定點數 | 自動平倉 |
| 止盈 | 獲利達設定點數 | 自動平倉 |

每個策略可獨立設定停損/止盈點數。

### 5.4 訂單管理

| 功能 | 說明 |
|------|------|
| 建立訂單 | create_order |
| 提交訂單 | submit_order |
| 成交回報 | fill_order |
| 取消訂單 | cancel_order |
| 拒絕訂單 | reject_order |

---

## 6. 監控功能

### 6.1 績效監控

即時顯示：
- 當日損益
- 開倉部位未實現損益
- 總口數
- 風控狀態

### 6.2 策略狀態監控

| 狀態項目 | 說明 |
|----------|------|
| 策略程式碼 | LLM 生成的程式碼 |
| 類別名稱 | 策略類別名稱 |
| 生成時間 | strategy_generated_at |
| 版本號 | strategy_version |
| 程式碼雜湊 | prompt_hash |

### 6.3 下單記錄 Log

記錄內容：
- 訂單 ID
- 策略 ID
- 合約代碼
- 方向/數量
- 價格
- 狀態
- 時間戳

### 6.4 系統狀態

| 狀態項目 | 說明 |
|----------|------|
| Shioaji 連線 | 連線/斷線 |
| 策略數 | 總數/啟用數 |
| 部位數 | 當前持有 |
| 待處理訂單 | 委託中數量 |

---

## 7. 設定選項

### 7.1 風控參數 (config.yaml)

```yaml
risk:
  max_daily_loss: 50000      # 單日最大虧損 (元)
  max_position: 10           # 最大口數
  max_orders_per_minute: 5   # 每分鐘最大下單數
  enable_stop_loss: true     # 啟用停損
  enable_take_profit: true   # 啟用止盈
```

### 7.2 通知設定

```yaml
telegram:
  enabled: true               # 啟用通知
  bot_token: "YOUR_TOKEN"    # Bot Token
  chat_id: "YOUR_CHAT_ID"   # 接收訊息的 ID
```

### 7.3 策略參數

```yaml
# 策略為選填，若有需要可在此設定
strategies: []  # 系統不從這裡載入策略，改用 Telegram 對話建立
```

**注意**：系統採用對話式策略建立，策略 ID 會自動生成（如 MXFA01）。

---

## 8. 資料儲存

### 8.1 Per-Strategy 儲存結構

系統採用 per-strategy + versioning 檔案結構：

```
workspace/
├── strategies/           # 策略（per-strategy + versioning）
│   ├── MXFA01_v1.json    # 策略 ID：期貨代碼 + 3位隨機字符
│   ├── MXFA01_v2.json
│   └── ...
├── positions/           # 部位（per-strategy）
│   ├── MXFA01_positions.json
│   └── ...
├── orders/             # 訂單（per-strategy）
│   ├── MXFA01_orders.json
│   └── ...
├── signals/            # 訊號（per-strategy + versioning）
│   ├── MXFA01_v1.json
│   ├── MXFA01_v2.json
│   └── ...
└── performance.json
```

### 8.2 刪除策略

刪除策略時會同時刪除以下檔案：

| 檔案類型 | 位置 |
|----------|------|
| 策略 | `workspace/strategies/{id}_v*.json` |
| 部位 | `workspace/positions/{id}_positions.json` |
| 訂單 | `workspace/orders/{id}_orders.json` |
| 訊號 | `workspace/signals/{id}_v*.json` |

---

## 9. 安全機制

### 9.1 下單前檢查

```
1. 檢查下單頻率
   └── 超過限制 → 拒絕下單

2. 檢查最大部位
   └── 超過限制 → 拒絕下單

3. 檢查單日虧損
   └── 超過限制 → 停止所有交易

4. 檢查價格合理性
   └── 超出漲跌停 → 拒絕下單
```

### 9.2 異常處理

| 異常情況 | 處理方式 |
|----------|----------|
| API 錯誤 | 記錄日誌，回傳錯誤訊息 |
| 網路中斷 | 自動重連，發送通知 |
| 風控擋單 | 回傳擋單原因 |
| 部位異常 | 發送警告通知 |
| LLM 失敗 | 策略暫停執行，發送通知 |

---

## 11. 自我優化 AI 交易系統

### 11.1 系統願景

本系統的核心理念是打造一個**自我優化的 AI 交易系統**：

```
用戶輸入目標 → LLM 設計策略 → 執行 → 績效分析 → LLM 審查優化 → 達成目標
```

### 11.2 目標設定

#### 目標結構

每個策略可以設定明確的數值目標：

| 欄位 | 類型 | 說明 | 範例 |
|------|------|------|------|
| `goal` | float | 目標數值（必須為數字）| 500 |
| `goal_unit` | string | 目標單位 | daily/weekly/monthly/quarterly/yearly |

#### 目標單位

| 單位 | 說明 | 範例 |
|------|------|------|
| `daily` | 每日目標 | 每日賺 500 元 |
| `weekly` | 每週目標 | 每週賺 3000 元 |
| `monthly` | 每月目標 | 每月賺 15000 元 |
| `quarterly` | 每季目標 | 每季賺 50000 元 |
| `yearly` | 每年目標 | 每年賺 200000 元 |

#### config.yaml 範例

```yaml
# 系統採用對話式策略建立，config.yaml 中的 strategies 欄位已移除
# 策略目標透過 Telegram 命令設定：goal <ID> <金額> <單位>
# 例如：goal MXFA01 500 daily
```

### 11.3 訊號記錄系統

#### 記錄內容

每次策略產生交易訊號時，系統會記錄：

| 欄位 | 說明 |
|------|------|
| `signal_id` | 訊號唯一識別碼 |
| `strategy_id` | 策略 ID |
| `strategy_version` | 策略版本號 |
| `timestamp` | 訊號產生時間 |
| `signal` | 訊號類型 (buy/sell/close) |
| `price` | 訊號產生時的價格 |
| `indicators` | 當時的指標值 (RSI, MACD 等) |
| `status` | 狀態 (pending/filled/cancelled) |
| `exit_reason` | 出場原因 (stop_loss/take_profit/signal_reversal) |
| `exit_price` | 出場價格 |
| `pnl` | 損益 |

#### 版本化儲存

系統採用 per-strategy + versioned 檔案結構：

```
workspace/
├── strategies/           # 策略（per-strategy + versioning）
│   ├── MXFA01_v1.json
│   ├── MXFA01_v2.json
│   └── ...
├── positions/          # 部位（per-strategy）
│   ├── MXFA01_positions.json
│   ├── TXF01_positions.json
│   └── ...
├── orders/             # 訂單（per-strategy）
│   ├── MXFA01_orders.json
│   ├── TXF01_orders.json
│   └── ...
├── signals/            # 訊號（per-strategy + versioning）
│   ├── MXFA01_v1.json
│   ├── MXFA01_v2.json
│   └── ...
└── performance.json
```

**優點**：
- 每個策略的資料完全隔離
- 策略版本更新時，舊版本資料保留供參考
- 查詢特定策略時效率更高
- LLM Review 只分析最新版本的表現
- 策略 ID 自動生成，格式清晰

#### 版本遞增時機

| 時機 | 動作 |
|------|------|
| 更新策略 Prompt | 版本遞增 (v1 → v2) |
| 確認優化修改 | 版本遞增 (v1 → v2) |

#### 訊號與部位關聯

部位記錄會關聯訊號 ID 和版本號：

```json
{
    "strategy_id": "MXFA01",
    "strategy_version": 2,
    "signal_id": "sig_abc123...",
    ...
}
```

平倉時會根據 `signal_id` 更新訊號記錄的 `exit_reason` 和 `pnl`。

### 11.4 績效分析

#### 分析維度

| 維度 | 說明 |
|------|------|
| 訊號統計 | 總訊號數、成交數、勝率 |
| 損益統計 | 已實現損益、平均損益、最大單次獲利/虧損 |
| 停損止盈統計 | 停損觸發次數、止盈觸發次數、訊號反向次數 |
| 版本隔離 | 只分析最新版本的訊號 |

#### 版本化分析

LLM Review 和績效查詢預設分析**最新版本**的訊號，確保分析結果反映當前策略的實際表現。

```
performance MXFA01 month
→ 分析 MXFA01_v2.json (最新版本)

review MXFA01
→ 分析 MXFA01_v2.json (最新版本)
```

#### 目標達成判斷

| 目標單位 | 判斷方式 |
|----------|----------|
| `daily` | 日平均損益 >= 目標 |
| `weekly` | 週平均損益 >= 目標 |
| `monthly` | 月總損益 >= 目標 |
| `quarterly` | 季總損益 >= 目標 |
| `yearly` | 年總損益 >= 目標 |

### 11.5 LLM 策略審查

#### 審查流程

```
1. 取得策略績效分析
2. 檢查目標是否達成
   ├── 已達成 → 回報成功，維持現狀
   └── 未達成 → 進入 LLM 審查
3. LLM 分析問題並給出建議
4. 展示建議給用戶
5. 用戶確認修改 / 取消
```

#### LLM 建議類型

LLM 審查後可能給出以下建議：

| 類型 | 說明 | 範例 |
|------|------|------|
| 參數調整 | 修改停損、止盈、數量等 | 「停損太近，建議從 30 點改為 50 點」 |
| Prompt 微調 | 修改交易邏輯描述 | 「建議加入 MACD 確認訊號，避免假突破」 |
| 重新設計 | 完全重新設計策略 | 「 RSI 策略不適合當前市場，建議改用趨勢策略」 |

#### 重新生成策略

當 LLM 建議修改 Prompt 時，系統會：

1. 更新策略的 `prompt` 欄位
2. 呼叫 LLM 策略生成器重新產生策略程式碼
3. 確認新策略無誤後部署

### 11.6 完整優化循環

```
┌─────────────────────────────────────────────────────────────────────┐
│                    自我優化循環流程                                    │
└─────────────────────────────────────────────────────────────────────┘

     ┌──────────────┐
     │ User 輸入   │
     │ "每日賺500元" │
     └──────┬───────┘
            │
            ▼
     ┌──────────────────────────────────────┐
     │ Goal-Driven Strategy Creation         │
     │ LLM 分析目標 → 推斷參數 → 用戶確認   │
     └──────┬───────────────────────────────┘
            │
            ▼
     ┌──────────────────────────────────────┐
     │ 策略執行階段                          │
     │ 訊號產生 → 下單 → 記錄訊號 → 更新結果 │
     └──────┬───────────────────────────────┘
            │
            ▼
     ┌──────────────────────────────────────┐
     │ 績效分析                              │
     │ 計算統計 → 檢查目標是否達成            │
     └──────┬───────────────────────────────┘
            │
     ┌──────┴──────┐
     │             │
   達成          未達成
     │             │
     ▼             ▼
   維持        ┌────────────────────┐
   現狀        │ LLM 策略審查       │
              │ 分析問題 → 建議修改 │
              └────────┬───────────┘
                       │
                       ▼
              ┌────────────────────┐
              │ 展示建議給用戶     │
              │ 1. 參數調整       │
              │ 2. Prompt 微調    │
              │ 3. 重新設計       │
              └────────┬───────────┘
                       │
              ┌────────┴────────┐
              │                 │
           確認             取消
              │                 │
              ▼                 ▼
         更新策略         維持現狀
         繼續執行           │
              │             │
              └─────────────┘
```

### 11.7 可用命令

| 命令 | 功能 |
|------|------|
| `goal <ID> <金額> <單位>` | 設定策略目標 |
| `performance <ID>` | 查詢策略績效 |
| `performance <ID> today/week/month/quarter/year` | 查詢特定期間績效 |
| `performance <ID> <begin_date> <end_date>` | 自訂日期範圍 |
| `review <ID>` | LLM 審查策略並給出建議 |
| `optimize <ID>` | 執行完整優化流程 |
| `confirm optimize` | 確認執行優化修改 |

### 11.8 目標單位

| 單位 | 說明 | 範例 |
|------|------|------|
| `daily` | 每日目標 | goal 策略ID 500 daily |
| `weekly` | 每週目標 | goal 策略ID 3000 weekly |
| `monthly` | 每月目標 | goal 策略ID 10000 monthly |
| `quarterly` | 每季目標 | goal 策略ID 30000 quarterly |
| `yearly` | 每年目標 | goal 策略ID 120000 yearly |

### 11.9 數據架構

```
┌─────────────────────────────────────────────────────────────────────┐
│                        數據流向圖                                    │
└─────────────────────────────────────────────────────────────────────┘

Strategy Execution
      │
      ▼
┌─────────────────┐     ┌─────────────────┐
│ Signal Recorder │ ──► │ signals.json    │
└────────┬────────┘     └─────────────────┘
         │
         │ 平倉時更新
         ▼
┌─────────────────┐     ┌─────────────────┐
│ Performance     │ ◄── │ Shioaji API    │
│ Analyzer        │     │ (損益資料)     │
└────────┬────────┘     └─────────────────┘
         │
         │ 分析結果
         ▼
┌─────────────────┐
│ Strategy        │ ◄─── 策略目標
│ Reviewer (LLM) │      (goal, goal_unit)
└────────┬────────┘
         │
         │ 建議
         ▼
┌─────────────────┐
│ User confirms  │ ──► 修改參數 / 修改Prompt / 重新設計
└─────────────────┘
```

### 11.10 自動 LLM Review 排程

#### 功能說明

系統支援自動定時觸發 LLM 策略審查，無需用戶手動輸入命令。

#### config.yaml 設定

```yaml
auto_review:
  enabled: true
  schedules:
    - strategy_id: "MXFA01"
      period: 5
      unit: "day"      # 每 5 天觸發一次
    - strategy_id: "TXF001"
      period: 2
      unit: "week"    # 每 2 週觸發一次
```

#### 設定參數

| 參數 | 說明 |
|------|------|
| `enabled` | 是否啟用自動 review |
| `schedules` | 排程列表 |
| `strategy_id` | 策略 ID (如 MXFA01) |
| `period` | 週期數字 |
| `unit` | 單位 (day/week/month/quarter/year) |

#### 行為規則

| 規則 | 說明 |
|------|------|
| 每天最多觸發 1 次 | 排程觸發受限制，避免重複 |
| 手動 review 不受限 | 用戶輸入 `review <ID>` 不受限制 |
| 無 goal 跳過 | 沒有設定目標的策略不會觸發 |
| 長訊息分段 | Telegram 訊息過長會自動分段發送 |

#### 觸發流程

```
排程檢查 (每分鐘)
    │
    ▼
檢查策略是否存在 ── 否 ──► 跳過
    │
    ▼
檢查是否有 goal ── 否 ──► 跳過
    │
    ▼
檢查今天是否已觸發 ── 是 ──► 跳過
    │
    ▼
檢查是否到期 ── 否 ──► 跳過
    │
    ▼ 是
執行 LLM Review
    │
    ▼
發送通知 (含 LLM 建議)
    │
    ▼
記錄觸發時間
```

#### 排程狀態儲存

系統會自動儲存以下資訊到 `workspace/auto_review_last.json`：

```json
{
  "last_review_times": {
    "MXFA01": "2026-02-18T10:30:00"
  },
  "last_trigger_date": {
    "MXFA01": "2026-02-18"
  }
}
```

---

## 12. 開發規劃

### 12.1 開發階段總覽

自我優化系統分為三個階段開發：

| 階段 | 功能 | 狀態 |
|------|------|------|
| 第一階段 | 目標設定 + 訊號記錄 + 基礎績效分析 | 待開發 |
| 第二階段 | LLM 策略審查功能 | 待開發 |
| 第三階段 | 半自動優化循環 | 待開發 |

### 12.2 第一階段：目標設定 + 訊號記錄 + 基礎績效分析

#### 目標
建立訊號記錄機制，儲存每次交易決策的完整資料，供後續分析使用

#### 開發內容

1. **目標欄位**
   - 新增 `goal` 欄位（float）：目標數值
   - 新增 `goal_unit` 欄位：daily/weekly/monthly/quarterly/yearly

2. **訊號記錄系統**
   - 建立 `SignalRecorder` 類別
   - 建立 `signals.json` 儲存檔案
   - 記錄每次成交訊號的詳細資料

3. **績效分析模組**
   - 建立 `PerformanceAnalyzer` 類別
   - 訊號統計分析
   - 損益統計分析
   - 目標達成判斷

4. **整合**
   - 整合訊號記錄到策略執行流程
   - 新增 `performance` 命令

#### 預估工作時數
- 約 4-6 小時

---

### 12.3 第二階段：LLM 策略審查功能

#### 目標
讓 LLM 根據績效分析結果，提供策略修改建議

#### 開發內容

1. **Strategy Reviewer**
   - 建立 `StrategyReviewer` 類別
   - LLM 分析策略問題
   - 產生修改建議

2. **建議類型**
   - 參數調整建議
   - Prompt 微調建議
   - 重新設計建議

3. **整合**
   - 新增 `review` 命令

#### 預估工作時數
- 約 3-4 小時

---

### 12.4 第三階段：半自動優化循環

#### 目標
建立半自動的優化循環，讓用戶可以持續優化策略直到達成目標

#### 開發內容

1. **優化流程 Tool**
   - 自動分析目標達成狀態
   - 根據情況觸發 LLM 審查
   - 用戶確認機制

2. **修改類型處理**
   - 參數修改
   - Prompt 修改 + 重新生成策略
   - 全新策略設計

3. **整合**
   - 新增 `optimize` 命令
   - 與現有系統完全整合

#### 預估工作時數
- 約 4-5 小時

---

### 12.5 開發優先順序

```
第一階段 (P0)
├── goal 欄位 + config
├── SignalRecorder
├── PerformanceAnalyzer
├── 整合到 runner
└── performance 命令

第二階段 (P1)
├── StrategyReviewer
└── review 命令

第三階段 (P2)
└── optimize 命令
```

---

## 13. 版本資訊

| 版本 | 日期 | 說明 |
|------|------|------|
| 1.0.0 | 2026-01 | 初始版本，支援3個策略 |
| 2.0.0 | 2026-02 | 新增 LLM 策略生成器與策略框架 |
| 2.1.0 | 2026-02 | 新增 Telegram Bot 接收機制 |
| 3.0.0 | 2026-02 | 新增自我優化系統 - 目標設定、訊號記錄、績效分析 |
| 3.1.0 | 2026-02 | 新增自我優化系統 - LLM 策略審查 |
| 3.2.0 | 2026-02 | 新增自我優化系統 - 半自動優化循環 |
| 3.3.0 | 2026-02 | 新增自動 LLM Review 排程功能 |
| 3.4.0 | 2026-02 | 新增版本化訊號儲存，策略更新時自動遞增版本 |
| 3.5.0 | 2026-02 | 重構儲存系統，採用 per-strategy 結構 |
| 3.6.0 | 2026-02 | 新增 Fallback 命令處理機制，確保基本命令執行成功 |
