# AI 期貨交易系統 - 功能說明

## 1. 核心功能

### 1.1 策略類型：兩階段執行

系統支援兩種策略執行模式：

#### A. LLM 策略生成（主要模式）
- 用戶輸入自然語言策略描述
- LLM 生成完整策略程式碼
- 策略繼承 `TradingStrategy` 框架
- 支援任意複雜邏輯
- LLM 失敗時策略暫停執行

### 1.2 多策略管理

系統支援最多3個獨立策略，每個策略具有以下特性：

| 特性 | 說明 |
|------|------|
| 策略 ID | 唯一識別碼 (如 strategy_001) |
| 策略名稱 | 自定義名稱 |
| 期貨合約 | 綁定特定期貨 (TXF/MXF/EFF) |
| 策略 Prompt | AI 交易邏輯描述 |
| 部位大小 | 預設口數 |
| 停損點數 | 停損金額 |
| 止盈點數 | 止盈金額 |
| 啟用狀態 | 啟用/停用 |

### 1.3 策略版本管理

| 功能 | 說明 |
|------|------|
| 程式碼儲存 | 策略程式碼儲存於 strategies.json |
| 版本號 | strategy_version 遞增 |
| Prompt Hash | 檢測策略是否需要重新生成 |
| 自動更新 | Prompt 變更時自動重新生成 |

### 1.4 自動盯盤機制

系統定時執行以下檢查：

| 檢查項目 | 頻率 | 說明 |
|----------|------|------|
| 連線狀態 | 每次迴圈 | 檢查 Shioaji 連線 |
| 部位價格 | 每次迴圈 | 更新部位現價與損益 |
| 停損觸發 | 每次迴圈 | 檢查是否觸發停損 |
| 止盈觸發 | 每次迴圈 | 檢查是否觸發止盈 |
| 當日損益 | 每次迴圈 | 更新風控損益 |

---

## 2. LLM 策略生成功能

### 2.1 策略 Prompt 輸入

使用者可以透過自然語言描述交易策略，系統會自動生成策略程式碼。

```
範例：
"當RSI低於30買進，RSI高於70賣出"
"漲幅超過5%且成交量是平均的2倍買進"
"買進後，如果遇到漲停板隔日跌-6%以上就平倉"
```

### 2.2 策略複雜度支援

| 策略類型 | 範例 | 支援狀態 |
|----------|------|----------|
| 簡單指標 | RSI < 30 買入 | ✅ 支援 |
| 複合條件 | RSI < 30 且 MACD 金叉 | ✅ 支援 |
| 狀態追蹤 | 漲停後次日跌 6% 平倉 | ✅ 支援 |
| 百分比停損 | 虧損 6% 平倉 | ✅ 支援 |
| 多指標組合 | RSI + MACD + MA | ✅ 支援 |

### 2.3 策略 Prompt 範例

```python
# 範例 1：RSI 策略
"RSI 低於 30 買入，RSI 高於 70 賣出"

# 範例 2：MACD 交叉策略  
"MACD 金叉買入，死叉賣出"

# 範例 3：漲停板策略
"買進後，如果遇到漲停板隔日跌-6%以上就平倉"

# 範例 4：成交量策略
"成交量暴增超過平均2倍且價格上漲買入"

# 範例 5：布林帶策略
"價格跌破布林下軌買入，漲破上軌賣出"
```

### 2.4 LLM 失敗處理

當 LLM 策略生成失敗時：
1. 系統記錄錯誤日誌
2. 策略不會執行
3. 發送 Telegram 通知給用戶
4. 用戶可修改策略描述後重新嘗試

---

## 3. 風控管理

### 3.1 風控項目

| 風控項目 | 預設值 | 說明 |
|----------|--------|------|
| 單日最大虧損 | 50,000 元 | 超過後停止交易 |
| 最大部位口數 | 10 口 | 所有策略合計 |
| 下單頻率 | 5 次/分鐘 | 防止過度交易 |
| 停損啟用 | 開啟 | 可設定關閉 |
| 止盈啟用 | 開啟 | 可設定關閉 |

### 3.2 斷線斷網處理

| 狀況 | 處理方式 |
|------|----------|
| 連線中斷 | 自動偵測，發送通知 |
| 斷線重連 | 最多50次，每次間隔5秒 |
| 重連失敗 | 持續嘗試並通知 |
| API 逾時 | 回傳錯誤，不阻斷系統 |

### 3.3 Telegram 回報

| 事件類型 | 通知內容 |
|----------|----------|
| 系統啟動 | 啟動訊息、模式、策略數 |
| 成交通知 | 合約、方向、數量、價格 |
| 委託取消 | 取消通知 |
| 停損觸發 | 平倉資訊、損益 |
| 止盈觸發 | 平倉資訊、損益 |
| 連線異常 | 斷線/重連通知 |
| 系統錯誤 | 錯誤訊息 |

---

## 4. 技術指標

### 4.1 pandas_ta 支援

系統使用 pandas_ta 計算技術指標（TA-Lib 已被移除）：

| 指標 | 說明 | 參數 |
|------|------|------|
| RSI | 相對強弱指標 | period=14 |
| MACD | 指數平滑異同移動平均線 | fast=12, slow=26, signal=9 |
| SMA | 簡單移動平均 | period=20 |
| EMA | 指數移動平均 | period=20 |
| BB | 布林帶 | period=20, std=2.0 |
| ATR | 平均真實波幅 | period=14 |
| STOCH | KD 指標 | period=14 |
| ADX | 平均趨向指標 | period=14 |
| CCI | 商品通道指標 | period=20 |
| OBV | 能量潮 | - |
| VWAP | 成交量加權平均價 | - |
| WILLR | 威廉指標 | period=14 |

### 4.2 動態 K 棒緩衝

| 指標參數 | 緩衝計算 | 範例 |
|----------|----------|------|
| RSI (14) | period + period | 14 + 14 = 28 根 |
| MA (5, 20) | long_period + long_period | 20 + 20 = 40 根 |
| MACD | 34 + 34 | 68 根 |
| BB (20) | period + period | 20 + 20 = 40 根 |

---

## 5. 交易功能

### 5.1 下單機

| 功能 | 說明 |
|------|------|
| 下單方式 | 限價單 (LMT) |
| 委託類型 | ROD (當日有效) |
| 倉位類型 | 自動 (新倉/平倉) |
| 非阻塞 | 支援非阻塞下單 |

### 5.2 策略上下線控制

| 操作 | 說明 |
|------|------|
| 啟用策略 | 啟動策略並生成程式碼 |
| 停用策略 | 停止策略執行 |
| 重新生成 | 修改 prompt 後自動重新生成 |

### 5.3 停損止盈

| 類型 | 觸發條件 | 動作 |
|------|----------|------|
| 停損 | 虧損達設定點數 | 自動平倉 |
| 止盈 | 獲利達設定點數 | 自動平倉 |

每個策略可獨立設定停損/止盈點數。

### 5.4 訂單管理

| 功能 | 說明 |
|------|------|
| 建立訂單 | create_order |
| 提交訂單 | submit_order |
| 成交回報 | fill_order |
| 取消訂單 | cancel_order |
| 拒絕訂單 | reject_order |

---

## 6. 監控功能

### 6.1 績效監控

即時顯示：
- 當日損益
- 開倉部位未實現損益
- 總口數
- 風控狀態

### 6.2 策略狀態監控

| 狀態項目 | 說明 |
|----------|------|
| 策略程式碼 | LLM 生成的程式碼 |
| 類別名稱 | 策略類別名稱 |
| 生成時間 | strategy_generated_at |
| 版本號 | strategy_version |
| 程式碼雜湊 | prompt_hash |

### 6.3 下單記錄 Log

記錄內容：
- 訂單 ID
- 策略 ID
- 合約代碼
- 方向/數量
- 價格
- 狀態
- 時間戳

### 6.4 系統狀態

| 狀態項目 | 說明 |
|----------|------|
| Shioaji 連線 | 連線/斷線 |
| 策略數 | 總數/啟用數 |
| 部位數 | 當前持有 |
| 待處理訂單 | 委託中數量 |

---

## 7. 設定選項

### 7.1 風控參數 (config.yaml)

```yaml
risk:
  max_daily_loss: 50000      # 單日最大虧損 (元)
  max_position: 10           # 最大口數
  max_orders_per_minute: 5   # 每分鐘最大下單數
  enable_stop_loss: true     # 啟用停損
  enable_take_profit: true   # 啟用止盈
```

### 7.2 通知設定

```yaml
telegram:
  enabled: true               # 啟用通知
  bot_token: "YOUR_TOKEN"    # Bot Token
  chat_id: "YOUR_CHAT_ID"   # 接收訊息的 ID
```

### 7.3 策略參數

```yaml
strategies:
  - id: "strategy_001"
    name: "台指 RSI 策略"
    symbol: "TXF"
    enabled: true
    prompt: "RSI 低於 30 買入，高於 70 賣出"
    params:
      timeframe: "15m"
      stop_loss: 50
      take_profit: 100
      position_size: 2
```

---

## 8. 資料儲存

### 8.1 strategies.json

存放3個策略的配置：
- 策略 ID
- 名稱
- 期貨合約代碼
- Prompt 描述
- **LLM 生成的程式碼**
- 啟用狀態
- 參數設定

### 8.2 positions.json

存放所有部位記錄：
- 策略 ID (關聯)
- 策略名稱
- 合約代碼
- 方向 (Buy/Sell)
- 數量
- 進場價
- 現價
- 損益
- 停損/止盈價

### 8.3 orders.json

存放所有訂單記錄：
- 訂單 ID
- 策略 ID (關聯)
- 合約代碼
- 動作
- 數量
- 價格
- 狀態
- 時間戳

### 8.4 performance.json

存放績效統計：
- 日期
- 策略 ID
- 總交易次數
- 獲利/虧損次數
- 勝率
- 總損益

---

## 9. 安全機制

### 9.1 下單前檢查

```
1. 檢查下單頻率
   └── 超過限制 → 拒絕下單

2. 檢查最大部位
   └── 超過限制 → 拒絕下單

3. 檢查單日虧損
   └── 超過限制 → 停止所有交易

4. 檢查價格合理性
   └── 超出漲跌停 → 拒絕下單
```

### 9.2 異常處理

| 異常情況 | 處理方式 |
|----------|----------|
| API 錯誤 | 記錄日誌，回傳錯誤訊息 |
| 網路中斷 | 自動重連，發送通知 |
| 風控擋單 | 回傳擋單原因 |
| 部位異常 | 發送警告通知 |
| LLM 失敗 | 策略暫停執行，發送通知 |

---

## 10. 版本資訊

| 版本 | 日期 | 說明 |
|------|------|------|
| 1.0.0 | 2026-01 | 初始版本，支援3個策略 |
| 2.0.0 | 2026-02 | 新增 LLM 策略生成器與策略框架 |
