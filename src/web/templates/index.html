{% extends "base.html" %}

{% block title %}ç³»çµ±ç¸½è¦½ - AISOTS{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">ğŸ“Š ç³»çµ±ç‹€æ…‹</div>
    <div id="systemStatus">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="card">
    <div class="card-header">ğŸ“‹ ç­–ç•¥æ¦‚è¦½</div>
    <div id="strategyOverview">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="card">
    <div class="card-header">ğŸ“¦ éƒ¨ä½æ¦‚è¦½</div>
    <div id="positionOverview">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="card">
    <div class="card-header">ğŸ›¡ï¸ é¢¨æ§ç‹€æ…‹</div>
    <div id="riskStatus">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <span>ğŸ“œ é‡è¦äº¤æ˜“è¨Šæ¯</span>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="logFilter" onchange="loadTradeLogs()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                <option value="">å…¨éƒ¨é¡å‹</option>
                <option value="ORDER_SUCCESS">ä¸‹å–®æˆåŠŸ</option>
                <option value="CLOSE_POSITION">å¹³å€‰</option>
                <option value="RISK_BLOCKED">é¢¨æ§æ“‹å–®</option>
                <option value="ORDER_FAILED">ä¸‹å–®å¤±æ•—</option>
            </select>
            <button onclick="loadTradeLogs()" class="btn btn-sm" style="padding: 5px 12px; font-size: 13px;">
                ğŸ”„ åˆ·æ–°
            </button>
        </div>
    </div>
    <div id="tradeLogs" style="max-height: 400px; overflow-y: auto;">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
    <div id="logStats" style="padding: 10px 20px; background: #f8f9fa; border-top: 1px solid #eee; font-size: 12px; color: #666;">
        çµ±è¨ˆè¼‰å…¥ä¸­...
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadSystemStatus() {
        try {
            const [statusRes, strategiesRes, positionsRes, riskRes, perfRes] = await Promise.all([
                fetch('/api/status'),
                fetch('/api/strategies'),
                fetch('/api/positions'),
                fetch('/api/risk'),
                fetch('/api/performance?period=today')
            ]);
            
            const statusData = await statusRes.json();
            const strategiesData = await strategiesRes.json();
            const positionsData = await positionsRes.json();
            const riskData = await riskRes.json();
            const perfData = await perfRes.json();
            
            // System Status
            document.getElementById('systemStatus').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">
                            <span class="status-dot status-dot-green"></span>æ­£å¸¸
                        </div>
                        <div style="color: #666; font-size: 12px;">ç³»çµ±é€£ç·š</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">${strategiesData.count || 0}</div>
                        <div style="color: #666; font-size: 12px;">ç­–ç•¥æ•¸</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">${positionsData.summary?.total_quantity || 0}</div>
                        <div style="color: #666; font-size: 12px;">éƒ¨ä½å£æ•¸</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">
                            ${(perfData.success ? perfData.total_pnl : positionsData.summary?.total_pnl || 0).toLocaleString()}
                        </div>
                        <div style="color: #666; font-size: 12px;">ç•¶æ—¥æç›Š</div>
                        ${perfData.success ? `
                        <div style="font-size: 10px; color: #999; margin-top: 2px;">
                            å·²å¯¦ç¾: ${perfData.realized_pnl.toLocaleString()} | æœªå¯¦ç¾: ${perfData.unrealized_pnl.toLocaleString()}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Strategy Overview
            const enabled = strategiesData.data?.filter(s => s.enabled).length || 0;
            const total = strategiesData.count || 0;
            document.getElementById('strategyOverview').innerHTML = `
                <div style="display: flex; gap: 30px;">
                    <div>å•Ÿç”¨: <strong>${enabled}</strong> / ${total}</div>
                    <div>åŸ·è¡Œä¸­: <strong>${strategiesData.data?.filter(s => s.is_running).length || 0}</strong></div>
                </div>
            `;
            
            // Position Overview
            const positions = positionsData.data || [];
            if (positions.length === 0) {
                document.getElementById('positionOverview').innerHTML = '<div class="empty-state">ç›®å‰ç„¡éƒ¨ä½</div>';
            } else {
                document.getElementById('positionOverview').innerHTML = positions.map(p => `
                    <div class="position-item">
                        <div>
                            <strong>${p.symbol}</strong> ${p.direction} ${p.quantity}å£
                            <span style="color: #666;">@ ${p.entry_price}</span>
                        </div>
                        <div class="${p.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                            ${p.pnl >= 0 ? '+' : ''}${p.pnl.toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }
            
            // Risk Status
            const risk = riskData.data || {};
            document.getElementById('riskStatus').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div>
                        <div style="font-weight: bold;">${risk.daily_pnl?.toLocaleString() || 0}</div>
                        <div style="color: #666; font-size: 12px;">ç•¶æ—¥æç›Š</div>
                    </div>
                    <div>
                        <div style="font-weight: bold;">${risk.current_position || 0} / ${risk.max_position || 0}</div>
                        <div style="color: #666; font-size: 12px;">éƒ¨ä½å£æ•¸</div>
                    </div>
                    <div>
                        <div style="font-weight: bold;">${risk.orders_this_minute || 0} / ${risk.max_orders_per_minute || 0}</div>
                        <div style="color: #666; font-size: 12px;">ä¸‹å–®é »ç‡</div>
                    </div>
                </div>
            `;
        } catch (e) {
            console.error('Error loading system status:', e);
            document.getElementById('systemStatus').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—: ' + e.message + '</div>';
            document.getElementById('strategyOverview').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            document.getElementById('positionOverview').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            document.getElementById('riskStatus').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
        }
    }
    
    // è¼‰å…¥äº¤æ˜“æ—¥èªŒ
    async function loadTradeLogs() {
        try {
            const filterType = document.getElementById('logFilter')?.value || '';
            const url = filterType 
                ? '/api/trade-logs?limit=50&event_type=' + filterType
                : '/api/trade-logs?limit=50';
            
            const [logsRes, statsRes] = await Promise.all([
                fetch(url),
                fetch('/api/trade-logs/stats')
            ]);
            
            const logsData = await logsRes.json();
            const statsData = await statsRes.json();
            
            if (!logsData.success) {
                throw new Error(logsData.error || 'è¼‰å…¥å¤±æ•—');
            }
            
            // é¡¯ç¤ºæ—¥èªŒ
            const logsContainer = document.getElementById('tradeLogs');
            const logs = logsData.data || [];
            
            if (logs.length === 0) {
                logsContainer.innerHTML = '<div class="empty-state">ç›®å‰ç„¡äº¤æ˜“æ—¥èªŒ</div>';
            } else {
                logsContainer.innerHTML = logs.map(function(log) {
                    const typeClass = getLogTypeClass(log.event_type);
                    const icon = getLogTypeIcon(log.event_type);
                    const pnlDisplay = log.details && log.details.pnl !== undefined 
                        ? '<div style="margin-top: 4px; font-size: 13px; font-weight: bold; color: ' + (log.details.pnl >= 0 ? '#27ae60' : '#e74c3c') + ';">æç›Š: ' + (log.details.pnl >= 0 ? '+' : '') + log.details.pnl.toLocaleString() + '</div>'
                        : '';
                    
                    return '<div style="padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px;">' +
                        '<span style="font-size: 16px;">' + icon + '</span>' +
                        '<div style="flex: 1;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">' +
                                '<span style="font-weight: 500; color: #2c3e50;">' + (log.strategy_name || log.strategy_id) + ' <span style="color: #999; font-size: 11px;">(' + log.strategy_id + ')</span></span>' +
                                '<span style="font-size: 12px; color: #999;">' + log.formatted_time + '</span>' +
                            '</div>' +
                            '<div style="font-size: 14px; color: #666; line-height: 1.4;">' + log.message + '</div>' +
                            pnlDisplay +
                        '</div>' +
                        '<span class="badge ' + typeClass + '" style="font-size: 11px; padding: 3px 8px;">' + log.event_type_display + '</span>' +
                    '</div>';
                }).join('');
            }
            
            // é¡¯ç¤ºçµ±è¨ˆ
            const statsContainer = document.getElementById('logStats');
            if (statsData.success) {
                const stats = statsData.data;
                statsContainer.innerHTML = 
                    '<span>24å°æ™‚: ' + stats.total_24h + ' ç­†</span> | ' +
                    '<span>7å¤©: ' + stats.total_7d + ' ç­†</span> | ' +
                    '<span>ä¸‹å–®: ' + (stats.by_type.ORDER_SUCCESS || 0) + '</span> | ' +
                    '<span>å¹³å€‰: ' + (stats.by_type.CLOSE_POSITION || 0) + '</span> | ' +
                    '<span>é¢¨æ§: ' + (stats.by_type.RISK_BLOCKED || 0) + '</span>';
            }
            
        } catch (e) {
            console.error('Error loading trade logs:', e);
            document.getElementById('tradeLogs').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—: ' + e.message + '</div>';
        }
    }
    
    function getLogTypeClass(eventType) {
        const classes = {
            'ORDER_SUCCESS': 'badge-success',
            'CLOSE_POSITION': 'badge-primary',
            'RISK_BLOCKED': 'badge-danger',
            'ORDER_FAILED': 'badge-warning',
            'SYSTEM': ''
        };
        return classes[eventType] || '';
    }
    
    function getLogTypeIcon(eventType) {
        const icons = {
            'ORDER_SUCCESS': 'âœ…',
            'CLOSE_POSITION': 'ğŸ“¤',
            'RISK_BLOCKED': 'ğŸ›¡ï¸',
            'ORDER_FAILED': 'âŒ',
            'SYSTEM': 'â„¹ï¸'
        };
        return icons[eventType] || 'ğŸ“';
    }
    
    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadSystemStatus();
    loadTradeLogs();
    
    // æ¯30ç§’è‡ªå‹•åˆ·æ–°
    setInterval(function() {
        loadSystemStatus();
        loadTradeLogs();
    }, REFRESH_INTERVAL);
</script>
{% endblock %}
