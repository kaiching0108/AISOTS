{% extends "base.html" %}

{% block title %}ç³»çµ±ç¸½è¦½ - AISOTS{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">ğŸ“Š ç³»çµ±ç‹€æ…‹</div>
    <div id="systemStatus">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="card">
    <div class="card-header">ğŸ“‹ ç­–ç•¥æ¦‚è¦½</div>
    <div id="strategyOverview">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="card">
    <div class="card-header">ğŸ“¦ éƒ¨ä½æ¦‚è¦½</div>
    <div id="positionOverview">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="card">
    <div class="card-header">ğŸ›¡ï¸ é¢¨æ§ç‹€æ…‹</div>
    <div id="riskStatus">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    // å®šä¹‰ REFRESH_INTERVALï¼ˆé˜²æ­¢ base.html æœªåŠ è½½ï¼‰
    if (typeof REFRESH_INTERVAL === 'undefined') {
        const REFRESH_INTERVAL = 30000;
    }
    
    // æµ‹è¯•ï¼šç«‹å³æ‰§è¡Œ
    window.onerror = function(msg, url, line, col, error) {
        console.error('Global error:', msg, 'at line', line);
    };
    
    console.log('Script starting...');
    
    async function loadSystemStatus() {
        console.log('loadSystemStatus called');
        try {
            const [statusRes, strategiesRes, positionsRes, riskRes] = await Promise.all([
                fetch('/api/status'),
                fetch('/api/strategies'),
                fetch('/api/positions'),
                fetch('/api/risk')
            ]);
            
            const statusData = await statusRes.json();
            const strategiesData = await strategiesRes.json();
            const positionsData = await positionsRes.json();
            const riskData = await riskRes.json();
            
            // System Status
            document.getElementById('systemStatus').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">
                            <span class="status-dot status-dot-green"></span>æ­£å¸¸
                        </div>
                        <div style="color: #666; font-size: 12px;">ç³»çµ±é€£ç·š</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">${strategiesData.count || 0}</div>
                        <div style="color: #666; font-size: 12px;">ç­–ç•¥æ•¸</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">${positionsData.summary?.total_quantity || 0}</div>
                        <div style="color: #666; font-size: 12px;">éƒ¨ä½å£æ•¸</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">
                            ${(positionsData.summary?.total_pnl || 0).toLocaleString()}
                        </div>
                        <div style="color: #666; font-size: 12px;">ç•¶æ—¥æç›Š</div>
                    </div>
                </div>
            `;
            
            // Strategy Overview
            const enabled = strategiesData.data?.filter(s => s.enabled).length || 0;
            const total = strategiesData.count || 0;
            document.getElementById('strategyOverview').innerHTML = `
                <div style="display: flex; gap: 30px;">
                    <div>å•Ÿç”¨: <strong>${enabled}</strong> / ${total}</div>
                    <div>åŸ·è¡Œä¸­: <strong>${strategiesData.data?.filter(s => s.is_running).length || 0}</strong></div>
                </div>
            `;
            
            // Position Overview
            const positions = positionsData.data || [];
            if (positions.length === 0) {
                document.getElementById('positionOverview').innerHTML = '<div class="empty-state">ç›®å‰ç„¡éƒ¨ä½</div>';
            } else {
                document.getElementById('positionOverview').innerHTML = positions.map(p => `
                    <div class="position-item">
                        <div>
                            <strong>${p.symbol}</strong> ${p.direction} ${p.quantity}å£
                            <span style="color: #666;">@ ${p.entry_price}</span>
                        </div>
                        <div class="${p.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                            ${p.pnl >= 0 ? '+' : ''}${p.pnl.toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }
            
            // Risk Status
            const risk = riskData.data || {};
            document.getElementById('riskStatus').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div>
                        <div style="font-weight: bold;">${risk.daily_pnl?.toLocaleString() || 0}</div>
                        <div style="color: #666; font-size: 12px;">ç•¶æ—¥æç›Š</div>
                    </div>
                    <div>
                        <div style="font-weight: bold;">${risk.current_position || 0} / ${risk.max_position || 0}</div>
                        <div style="color: #666; font-size: 12px;">éƒ¨ä½å£æ•¸</div>
                    </div>
                    <div>
                        <div style="font-weight: bold;">${risk.orders_this_minute || 0} / ${risk.max_orders_per_minute || 0}</div>
                        <div style="color: #666; font-size: 12px;">ä¸‹å–®é »ç‡</div>
                    </div>
                </div>
            `;
            
            // Debug: test fetch
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    console.log('Fetch success:', data);
                    document.getElementById('systemStatus').innerHTML = '<div class="empty-state">API æ­£å¸¸: ' + JSON.stringify(data).substring(0, 100) + '</div>';
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    document.getElementById('systemStatus').innerHTML = '<div class="empty-state">Fetch å¤±æ•—: ' + err.message + '</div>';
                });
        } catch (e) {
            console.error('Error loading system status:', e);
            document.getElementById('systemStatus').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—: ' + e.message + '</div>';
            document.getElementById('strategyOverview').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            document.getElementById('positionOverview').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            document.getElementById('riskStatus').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
        }
    }
    
    loadSystemStatus();
    setInterval(loadSystemStatus, REFRESH_INTERVAL);
</script>
{% endblock %}
