{% extends "base.html" %}

{% block title %}ç­–ç•¥ç®¡ç† - AISOTS{% endblock %}

{% block content %}
<!-- å·²å•Ÿç”¨çš„ç­–ç•¥å€åŸŸ -->
<div class="card" style="border-left: 4px solid #27ae60;">
    <div class="card-header" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white;">
        ğŸ“‹ å·²å•Ÿç”¨çš„ç­–ç•¥
    </div>
    <div id="enabledStrategyList">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<!-- æœªå•Ÿç”¨çš„ç­–ç•¥å€åŸŸ -->
<div class="card" style="margin-top: 20px; border-left: 4px solid #95a5a6;">
    <div class="card-header" style="background: linear-gradient(135deg, #95a5a6 0%, #bdc3c7 100%); color: white;">
        ğŸ“‹ æœªå•Ÿç”¨çš„ç­–ç•¥
    </div>
    <div id="disabledStrategyList">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ç­–ç•¥å¡ç‰‡ HTML ç”Ÿæˆå‡½æ•¸
    function generateStrategyCard(s) {
        return `
            <div class="strategy-item">
                <div class="strategy-header">
                    <div>
                        <span class="badge ${s.enabled ? 'badge-success' : 'badge-danger'}">
                            ${s.enabled ? 'âœ… å•Ÿç”¨' : 'âŒ åœç”¨'}
                        </span>
                        <span class="strategy-name">${s.name}</span>
                        <span style="color: #666; margin-left: 10px;">${s.id}</span>
                    </div>
                </div>
                <div class="strategy-info">
                    <div>æœŸè²¨: ${s.symbol}</div>
                    <div>ç‰ˆæœ¬: v${s.version}</div>
                    <div>é€±æœŸ: ${s.timeframe || '-'}</div>
                    <div>å£æ•¸: ${s.quantity || '-'}</div>
                    <div>æ–¹å‘: ${s.direction === 'short' ? 'åšç©º' : 'åšå¤š'}</div>
                    <div>åœæ: ${s.stop_loss || '-'} é»</div>
                    <div>åœåˆ©: ${s.take_profit || '-'} é»</div>
                    <div>å‰µå»º: ${s.created_at || '-'}</div>
                    <div>ç›®æ¨™: ${s.goal ? s.goal + '/' + (s.goal_unit === 'daily' ? 'æ—¥' : s.goal_unit === 'weekly' ? 'é€±' : s.goal_unit === 'monthly' ? 'æœˆ' : s.goal_unit) : 'æœªè¨­å®š'}</div>
                    ${s.goal ? `<div style="color: #27ae60; font-size: 12px;">è‡ªå‹• Review: æ¯ ${s.review_period} ${s.review_unit === 'day' ? 'å¤©' : s.review_unit === 'week' ? 'é€±' : s.review_unit === 'month' ? 'æœˆ' : s.review_unit}</div>` : '<div style="color: #999; font-size: 12px;">è¨­å®šç›®æ¨™å¾Œå¯å•Ÿç”¨è‡ªå‹• Review</div>'}
                </div>
                ${s.position ? `
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 13px;">
                    <strong>âš ï¸ ä»æœ‰éƒ¨ä½</strong>: ${s.position.direction} ${s.position.quantity}å£ @ ${s.position.entry_price}
                    (${s.position.pnl >= 0 ? '+' : ''}${s.position.pnl})
                </div>
                ` : ''}
                <div class="strategy-actions">
                    <button class="btn btn-primary btn-sm" onclick="editGoal('${s.id}', ${s.goal !== null && s.goal !== undefined ? s.goal : 'null'}, '${s.goal_unit || 'daily'}', ${s.review_period !== null && s.review_period !== undefined ? s.review_period : 5}, '${s.review_unit || 'day'}')">ğŸ¯ ç›®æ¨™</button>
                    ${s.enabled ? 
                        `<button class="btn btn-warning btn-sm" onclick="disableStrategy('${s.id}', ${s.has_position})">åœç”¨</button>` :
                        `<button class="btn btn-success btn-sm" onclick="enableStrategy('${s.id}')">å•Ÿç”¨</button>`
                    }
                    <button class="btn btn-primary btn-sm" onclick="runBacktest('${s.id}', '${s.name}')">å›æ¸¬</button>
                    <button class="btn btn-info btn-sm" onclick="viewCode('${s.id}')">ğŸ“„</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteStrategy('${s.id}', ${s.has_position})">åˆªé™¤</button>
                </div>
            </div>
        `;
    }
    
    async function loadStrategies() {
        try {
            console.log('Loading strategies...');
            const response = await fetch('/api/strategies');
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'API è¿”å›å¤±æ•—');
            }
            
            if (!data.data || data.data.length === 0) {
                document.getElementById('enabledStrategyList').innerHTML = '<div class="empty-state">ç›®å‰æ²’æœ‰ç­–ç•¥</div>';
                document.getElementById('disabledStrategyList').innerHTML = '<div class="empty-state">ç›®å‰æ²’æœ‰ç­–ç•¥</div>';
                return;
            }
            
            // å°‡ç­–ç•¥åˆ†ç‚ºå•Ÿç”¨å’Œæœªå•Ÿç”¨å…©çµ„
            const enabledStrategies = data.data.filter(s => s.enabled);
            const disabledStrategies = data.data.filter(s => !s.enabled);
            
            // æ¸²æŸ“å·²å•Ÿç”¨çš„ç­–ç•¥
            if (enabledStrategies.length === 0) {
                document.getElementById('enabledStrategyList').innerHTML = '<div class="empty-state" style="padding: 30px; color: #666;">ç›®å‰æ²’æœ‰å•Ÿç”¨çš„ç­–ç•¥</div>';
            } else {
                document.getElementById('enabledStrategyList').innerHTML = enabledStrategies.map(s => generateStrategyCard(s)).join('');
            }
            
            // æ¸²æŸ“æœªå•Ÿç”¨çš„ç­–ç•¥
            if (disabledStrategies.length === 0) {
                document.getElementById('disabledStrategyList').innerHTML = '<div class="empty-state" style="padding: 30px; color: #666;">ç›®å‰æ²’æœ‰æœªå•Ÿç”¨çš„ç­–ç•¥</div>';
            } else {
                document.getElementById('disabledStrategyList').innerHTML = disabledStrategies.map(s => generateStrategyCard(s)).join('');
            }
            
        } catch (e) {
            console.error('Error loading strategies:', e);
            const errorMsg = e.message || 'æœªçŸ¥éŒ¯èª¤';
            document.getElementById('enabledStrategyList').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—: ' + errorMsg + '</div>';
            document.getElementById('disabledStrategyList').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—: ' + errorMsg + '</div>';
        }
    }
    
    async function enableStrategy(id) {
        const result = await apiCall('/api/strategies/' + id + '/enable', 'POST');
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦ç¢ºèªï¼ˆèˆŠç­–ç•¥æœ‰éƒ¨ä½ï¼‰
        if (result.needs_confirmation) {
            showModal(
                result.title,
                result.message,
                result.risks,
                async () => {
                    const confirmResult = await apiCall('/api/strategies/' + id + '/enable', 'DELETE');
                    closeModal();
                    alert(confirmResult.message);
                    loadStrategies();
                }
            );
            return;
        }
        
        alert(result.message);
        loadStrategies();
    }
    
    async function disableStrategy(id, hasPosition) {
        if (hasPosition) {
            const checkRes = await apiCall('/api/strategies/' + id + '/disable', 'POST');
            if (checkRes.needs_confirmation) {
                showModal(
                    checkRes.title,
                    checkRes.message,
                    checkRes.risks,
                    async () => {
                        const result = await apiCall('/api/strategies/' + id + '/disable', 'DELETE');
                        closeModal();
                        alert(result.message);
                        loadStrategies();
                    }
                );
                return;
            }
            alert(checkRes.message);
        } else {
            const result = await apiCall('/api/strategies/' + id + '/disable', 'POST');
            alert(result.message);
        }
        loadStrategies();
    }
    
    async function deleteStrategy(id, hasPosition) {
        if (hasPosition) {
            const checkRes = await apiCall('/api/strategies/' + id, 'DELETE');
            if (checkRes.needs_confirmation) {
                showModal(
                    checkRes.title,
                    checkRes.message,
                    checkRes.risks,
                    async () => {
                        const result = await apiCall('/api/strategies/' + id + '/delete', 'DELETE');
                        closeModal();
                        alert(result.message);
                        loadStrategies();
                    }
                );
                return;
            }
            alert(checkRes.message);
        } else {
            showSimpleConfirmModal('åˆªé™¤ç­–ç•¥', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­–ç•¥å—ï¼Ÿ', async function() {
                const result = await apiCall('/api/strategies/' + id, 'DELETE');
                alert(result.message);
                loadStrategies();
            });
        }
    }
    
    async function runBacktest(id, strategyName) {
        try {
            // ç¬¬ä¸€æ­¥ï¼šæª¢æŸ¥æ˜¯å¦å­˜åœ¨æœ€æ–°å›æ¸¬å ±å‘Š
            console.log('æ­£åœ¨æª¢æŸ¥å›æ¸¬å ±å‘Š...', id);
            const checkResult = await apiCall('/api/backtest/' + id + '/check', 'GET');
            console.log('API è¿”å›:', checkResult);
            
            // ç¬¬äºŒæ­¥ï¼šé¡¯ç¤ºé¸æ“‡ Modal
            if (!checkResult.chart_path) {
                console.warn('è­¦å‘Š: chart_path ç‚ºç©º');
            }
            showBacktestChoiceModal(id, strategyName, checkResult);
            
        } catch (e) {
            console.error('æª¢æŸ¥å›æ¸¬å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
            // å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œç›´æ¥åŸ·è¡Œå›æ¸¬
            executeBacktest(id, strategyName);
        }
    }
    
    async function viewCode(id) {
        const result = await apiCall('/api/strategies/' + id, 'GET');
        if (result.success && result.data) {
            showCodeModal(result.data.name + ' (' + id + ')', result.data.strategy_code, result.data.prompt);
        } else {
            alert('è¼‰å…¥å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
    }
    
    async function editGoal(id, goal, goalUnit, reviewPeriod, reviewUnit) {
        showGoalModal(goal, goalUnit, reviewPeriod, reviewUnit, async function(data) {
            const result = await apiCall('/api/strategies/' + id + '/goal', 'POST', {
                goal: data.goal,
                goal_unit: data.goalUnit,
                review_period: data.reviewPeriod,
                review_unit: data.reviewUnit
            });
            
            alert(result.message);
            loadStrategies();
        });
    }
    
    function apiCall(url, method, body = null) {
        return fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: body ? JSON.stringify(body) : null
        }).then(r => r.json());
    }
    
    if (typeof REFRESH_INTERVAL === 'undefined') {
        const REFRESH_INTERVAL = 30000;
    }
    
    loadStrategies();
    setInterval(loadStrategies, REFRESH_INTERVAL);
</script>
{% endblock %}
