{% extends "base.html" %}

{% block title %}ç­–ç•¥ç®¡ç† - AISOTS{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">ğŸ“‹ ç­–ç•¥åˆ—è¡¨</div>
    <div id="strategyList">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadStrategies() {
        try {
            const response = await fetch('/api/strategies');
            const data = await response.json();
            
            if (!data.success || !data.data || data.data.length === 0) {
                document.getElementById('strategyList').innerHTML = '<div class="empty-state">ç›®å‰æ²’æœ‰ç­–ç•¥</div>';
                return;
            }
            
            document.getElementById('strategyList').innerHTML = data.data.map(s => `
                <div class="strategy-item">
                    <div class="strategy-header">
                        <div>
                            <span class="badge ${s.enabled ? 'badge-success' : 'badge-danger'}">
                                ${s.enabled ? 'âœ… å•Ÿç”¨' : 'âŒ åœç”¨'}
                            </span>
                            <span class="strategy-name">${s.name}</span>
                            <span style="color: #666; margin-left: 10px;">${s.id}</span>
                        </div>
                    </div>
                    <div class="strategy-info">
                        <div>æœŸè²¨: ${s.symbol}</div>
                        <div>ç‰ˆæœ¬: v${s.version}</div>
                        <div>é€±æœŸ: ${s.timeframe || '-'}</div>
                        <div>å£æ•¸: ${s.quantity || '-'}</div>
                    </div>
                    ${s.position ? `
                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 13px;">
                        <strong>âš ï¸ ä»æœ‰éƒ¨ä½</strong>: ${s.position.direction} ${s.position.quantity}å£ @ ${s.position.entry_price}
                        (${s.position.pnl >= 0 ? '+' : ''}${s.position.pnl})
                    </div>
                    ` : ''}
                    <div class="strategy-actions">
                        ${s.enabled ? 
                            `<button class="btn btn-warning btn-sm" onclick="disableStrategy('${s.id}', ${s.has_position})">åœç”¨</button>` :
                            `<button class="btn btn-success btn-sm" onclick="enableStrategy('${s.id}')">å•Ÿç”¨</button>`
                        }
                        <button class="btn btn-primary btn-sm" onclick="runBacktest('${s.id}')">å›æ¸¬</button>
                        <button class="btn btn-info btn-sm" onclick="viewCode('${s.id}')">ğŸ“„</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStrategy('${s.id}', ${s.has_position})">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error(e);
            document.getElementById('strategyList').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
        }
    }
    
    async function enableStrategy(id) {
        const result = await apiCall('/api/strategies/' + id + '/enable', 'POST');
        alert(result.message);
        loadStrategies();
    }
    
    async function disableStrategy(id, hasPosition) {
        if (hasPosition) {
            const checkRes = await apiCall('/api/strategies/' + id + '/disable', 'POST');
            if (checkRes.needs_confirmation) {
                showModal(
                    checkRes.title,
                    checkRes.message,
                    checkRes.risks,
                    async () => {
                        const result = await apiCall('/api/strategies/' + id + '/disable', 'DELETE');
                        closeModal();
                        alert(result.message);
                        loadStrategies();
                    }
                );
                return;
            }
            alert(checkRes.message);
        } else {
            const result = await apiCall('/api/strategies/' + id + '/disable', 'POST');
            alert(result.message);
        }
        loadStrategies();
    }
    
    async function deleteStrategy(id, hasPosition) {
        if (hasPosition) {
            const checkRes = await apiCall('/api/strategies/' + id, 'DELETE');
            if (checkRes.needs_confirmation) {
                showModal(
                    checkRes.title,
                    checkRes.message,
                    checkRes.risks,
                    async () => {
                        const result = await apiCall('/api/strategies/' + id + '/delete', 'DELETE');
                        closeModal();
                        alert(result.message);
                        loadStrategies();
                    }
                );
                return;
            }
            alert(checkRes.message);
        } else {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­–ç•¥å—ï¼Ÿ')) return;
            const result = await apiCall('/api/strategies/' + id, 'DELETE');
            alert(result.message);
        }
        loadStrategies();
    }
    
    async function runBacktest(id) {
        if (!confirm('ç¢ºå®šè¦åŸ·è¡Œå›æ¸¬å—ï¼Ÿ')) return;
        
        const result = await apiCall('/api/backtest/' + id, 'POST');
        if (result.success) {
            alert('å›æ¸¬å®Œæˆï¼\n\n' + result.report);
        } else {
            alert('å›æ¸¬å¤±æ•—: ' + (result.error || result.report));
        }
    }
    
    async function viewCode(id) {
        const result = await apiCall('/api/strategies/' + id, 'GET');
        if (result.success && result.data) {
            showCodeModal(result.data.name + ' (' + id + ')', result.data.strategy_code);
        } else {
            alert('è¼‰å…¥å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
    }
    
    loadStrategies();
    setInterval(loadStrategies, REFRESH_INTERVAL);
</script>
{% endblock %}
