{% extends "base.html" %}

{% block title %}éƒ¨ä½æŸ¥è©¢ - AISOTS{% endblock %}

{% block extra_css %}
<style>
    .filter-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    .filter-bar select, .filter-bar input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .filter-bar button {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .filter-bar button:hover {
        background: #2980b9;
    }
    .stats-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    .stats-item {
        text-align: center;
    }
    .stats-item .count {
        font-size: 24px;
        font-weight: bold;
    }
    .stats-item .label {
        font-size: 12px;
        color: #666;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    th {
        background: #f8f9fa;
        font-weight: bold;
    }
    tr:hover {
        background: #f8f9fa;
    }
    .position-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    .position-symbol {
        font-weight: bold;
        font-size: 16px;
    }
    .position-direction {
        margin-left: 10px;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
    }
    .direction-buy {
        background: #ffebee;
        color: #c62828;
    }
    .direction-sell {
        background: #e8f5e9;
        color: #2e7d32;
    }
    .position-details {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">ğŸ“¦ éƒ¨ä½åˆ—è¡¨</div>
    
    <div class="filter-bar">
        <select id="strategyFilter">
            <option value="">å…¨éƒ¨ç­–ç•¥</option>
        </select>
        <button onclick="loadPositions()">ç¯©é¸</button>
    </div>
    
    <div class="stats-bar" id="statsBar">
        <div class="stats-item">
            <div class="count" id="statTotal">0</div>
            <div class="label">ç¸½éƒ¨ä½</div>
        </div>
        <div class="stats-item">
            <div class="count" id="statQuantity">0</div>
            <div class="label">ç¸½å£æ•¸</div>
        </div>
        <div class="stats-item">
            <div class="count" id="statPnl" style="color: #27ae60;">0</div>
            <div class="label">ç¸½æç›Š</div>
        </div>
    </div>
    
    <div id="positionList">
        <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadStrategies() {
    try {
        const response = await fetch('/api/strategies');
        const data = await response.json();
        
        if (data.success && data.data) {
            const select = document.getElementById('strategyFilter');
            data.data.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.id} - ${s.name || s.id}`;
                select.appendChild(option);
            });
        }
    } catch (e) {
        console.error('è¼‰å…¥ç­–ç•¥å¤±æ•—:', e);
    }
}

async function loadPositions() {
    const strategyId = document.getElementById('strategyFilter').value;
    
    let url = '/api/positions?';
    if (strategyId) {
        url += `strategy_id=${strategyId}&`;
    }
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.success || !data.data || data.data.length === 0) {
            document.getElementById('positionList').innerHTML = '<div class="empty-state">ç›®å‰æ²’æœ‰éƒ¨ä½</div>';
            document.getElementById('statTotal').textContent = '0';
            document.getElementById('statQuantity').textContent = '0';
            document.getElementById('statPnl').textContent = '0';
            return;
        }
        
        const positions = data.data;
        
        document.getElementById('statTotal').textContent = positions.length;
        document.getElementById('statQuantity').textContent = data.summary.total_quantity;
        
        const totalPnl = data.summary.total_pnl || 0;
        document.getElementById('statPnl').textContent = (totalPnl >= 0 ? '+' : '') + totalPnl.toLocaleString();
        document.getElementById('statPnl').style.color = totalPnl >= 0 ? '#27ae60' : '#e74c3c';
        
        document.getElementById('positionList').innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>ç­–ç•¥</th>
                        <th>æœŸè²¨</th>
                        <th>æ–¹å‘</th>
                        <th>å£æ•¸</th>
                        <th>é€²å ´åƒ¹</th>
                        <th>ç¾åƒ¹</th>
                        <th>æç›Š</th>
                    </tr>
                </thead>
                <tbody>
                    ${positions.map(p => `
                        <tr>
                            <td>${p.strategy_id}</td>
                            <td><strong>${p.symbol}</strong></td>
                            <td><span class="position-direction ${p.direction === 'Buy' ? 'direction-buy' : 'direction-sell'}">${p.direction === 'Buy' ? 'å¤š' : 'ç©º'}</span></td>
                            <td>${p.quantity}</td>
                            <td>${p.entry_price}</td>
                            <td>${p.current_price}</td>
                            <td class="${p.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}" style="font-weight: bold;">
                                ${p.pnl >= 0 ? '+' : ''}${p.pnl.toLocaleString()}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (e) {
        console.error(e);
        document.getElementById('positionList').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
    }
}

loadStrategies();
loadPositions();
setInterval(loadPositions, 30000);
</script>
{% endblock %}
